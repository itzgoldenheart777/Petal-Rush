<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<meta name="theme-color" content="#0e0e07">
<title>Petal Rush ‚Äî Sign In</title>
<link rel="stylesheet" href="assets/css/styles.css">
<style>
/* ‚îÄ‚îÄ AUTH-SPECIFIC STYLES ‚îÄ‚îÄ */
body { display:flex; align-items:center; justify-content:center; min-height:100vh; padding:20px; }

.auth-wrap {
  width:100%; max-width:420px;
  position:relative; z-index:1;
}

.auth-brand {
  text-align:center; margin-bottom:40px;
}
.auth-brand h1 {
  font-size:clamp(48px,10vw,72px);
  color:var(--gold); letter-spacing:0.08em;
  line-height:1;
}
.auth-brand .tagline {
  font-size:10px; letter-spacing:0.5em; text-transform:uppercase;
  color:var(--text-muted); margin-top:10px;
  display:flex; align-items:center; justify-content:center; gap:10px;
}
.auth-brand .tagline::before, .auth-brand .tagline::after {
  content:''; width:30px; height:1px; background:var(--border);
}

/* Config section */
.config-wrap {
  background:rgba(201,168,76,0.07); border:1px solid rgba(201,168,76,0.2);
  border-radius:var(--r); padding:20px; margin-bottom:20px;
}
.config-wrap h3 { font-size:16px; color:var(--gold); margin-bottom:6px; }
.config-wrap p  { font-size:12px; color:var(--text-muted); margin-bottom:14px; line-height:1.5; }
.config-status {
  display:flex; align-items:center; gap:8px;
  font-size:12px; padding:8px 12px; border-radius:6px;
  margin-bottom:14px;
}
.config-status.connected    { background:rgba(74,124,89,0.15); color:var(--green-light); border:1px solid rgba(74,124,89,0.3); }
.config-status.disconnected { background:rgba(196,83,90,0.1); color:var(--rose-light); border:1px solid rgba(196,83,90,0.2); }

/* Auth card */
.auth-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:16px; padding:32px;
  box-shadow:var(--shadow-lg); position:relative;
}
.auth-card::before {
  content:''; position:absolute; top:0; left:0; right:0; height:1px;
  border-radius:16px 16px 0 0;
  background:linear-gradient(90deg, transparent, rgba(201,168,76,0.5), transparent);
}

/* Role selector */
.role-grid {
  display:grid; grid-template-columns:repeat(2,1fr); gap:6px;
  margin-bottom:24px;
  background:var(--bg2); padding:4px; border-radius:10px;
}
.role-btn {
  padding:10px 8px; border:1px solid transparent;
  background:transparent; border-radius:7px; cursor:pointer;
  color:var(--text-muted); font-family:'DM Sans',sans-serif;
  font-size:11px; font-weight:500; letter-spacing:0.05em;
  display:flex; flex-direction:column; align-items:center; gap:4px;
  transition:all 0.15s;
}
.role-btn .ri { font-size:18px; }
.role-btn:hover { color:var(--text); }
.role-btn.active {
  background:var(--gold-dim); color:var(--gold);
  border-color:rgba(201,168,76,0.3);
}

/* Auth tabs */
.auth-tabs { display:flex; border-bottom:1px solid var(--border); margin-bottom:22px; }
.auth-tab-btn {
  padding:10px 18px; border:none; background:none;
  color:var(--text-muted); font-family:'DM Sans',sans-serif; font-size:14px;
  cursor:pointer; position:relative; transition:color 0.2s;
}
.auth-tab-btn.active { color:var(--gold); }
.auth-tab-btn.active::after {
  content:''; position:absolute; bottom:-1px; left:0; right:0; height:1px; background:var(--gold);
}

/* Footer */
.auth-footer { text-align:center; margin-top:20px; }
.auth-footer p { font-size:11px; color:var(--text-dim); line-height:1.6; }
</style>
</head>
<body>

<!-- Loading -->
<div id="loading-screen">
  <div class="loading-logo">Petal Rush</div>
  <div class="loading-sub">Premium Flower Marketplace</div>
  <div class="loading-ornament">
    <div class="loading-line"></div><span>üå∏</span><div class="loading-line"></div>
  </div>
  <div class="loading-bar"></div>
</div>

<!-- Toast -->
<div id="toast-container"></div>

<div class="auth-wrap" id="auth-wrap" style="display:none">
  <!-- Brand -->
  <div class="auth-brand">
    <h1>Petal Rush</h1>
    <div class="tagline">Premium Flower Marketplace</div>
  </div>

  <!-- Supabase Config -->
  <div class="config-wrap" id="config-wrap">
    <h3>‚öôÔ∏è Connect Supabase</h3>
    <p>Enter your Supabase project credentials. Find them in <strong style="color:var(--gold)">Project Settings ‚Üí API</strong>.</p>
    <div id="config-status-badge"></div>
    <div class="flex flex-col gap-1">
      <div class="form-group">
        <label>Project URL</label>
        <input type="url" id="sb-url" placeholder="https://xxxx.supabase.co" autocomplete="off" />
      </div>
      <div class="form-group">
        <label>Anon / Public Key</label>
        <input type="text" id="sb-key" placeholder="eyJhbGciOi..." autocomplete="off" />
      </div>
      <button class="btn btn-primary btn-full mt-1" id="connect-btn" onclick="connectSupabase()">
        Connect Database
      </button>
    </div>
    <div class="divider-text mt-2"><span>or explore without a database</span></div>
    <button class="btn btn-ghost btn-full btn-sm" onclick="enableDemo()">üé≠ Demo Mode (no login needed)</button>
  </div>

  <!-- Auth Card -->
  <div class="auth-card" id="auth-card">
    <!-- Role Selector -->
    <div class="role-grid">
      <button class="role-btn active" data-role="buyer" onclick="selectRole(this)"><span class="ri">üõçÔ∏è</span>Buyer</button>
      <button class="role-btn" data-role="seller" onclick="selectRole(this)"><span class="ri">üè™</span>Seller</button>
      <button class="role-btn" data-role="delivery" onclick="selectRole(this)"><span class="ri">üöö</span>Delivery</button>
      <button class="role-btn" data-role="admin" onclick="selectRole(this)"><span class="ri">üõ†Ô∏è</span>Admin</button>
    </div>

    <!-- Tabs -->
    <div class="auth-tabs">
      <button class="auth-tab-btn active" id="tab-login" onclick="switchTab('login')">Sign In</button>
      <button class="auth-tab-btn" id="tab-signup" onclick="switchTab('signup')">Create Account</button>
    </div>

    <!-- Login Form -->
    <div id="form-login">
      <div class="flex flex-col gap-2">
        <div class="form-group">
          <label>Email Address</label>
          <input type="email" id="l-email" placeholder="your@email.com" autocomplete="email" />
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="l-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"
            onkeydown="if(event.key==='Enter')doLogin()" />
        </div>
        <button class="btn btn-primary btn-full mt-1" id="login-btn" onclick="doLogin()">
          Sign In ‚Üí
        </button>
        <button class="btn btn-ghost btn-sm" style="font-size:12px;color:var(--text-dim)"
          onclick="doForgotPassword()">Forgot password?</button>
      </div>
    </div>

    <!-- Signup Form -->
    <div id="form-signup" class="hidden">
      <div class="flex flex-col gap-2">
        <div class="form-row">
          <div class="form-group">
            <label>Full Name *</label>
            <input type="text" id="s-name" placeholder="Jane Rose" autocomplete="name" />
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" id="s-phone" placeholder="+91 98765..." />
          </div>
        </div>
        <div class="form-group">
          <label>Email Address *</label>
          <input type="email" id="s-email" placeholder="your@email.com" autocomplete="email" />
        </div>
        <div class="form-group">
          <label>Password * (min 8 chars)</label>
          <input type="password" id="s-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password" />
        </div>
        <div class="form-group" id="shop-field" style="display:none">
          <label>Shop Name *</label>
          <input type="text" id="s-shop" placeholder="Rose Garden Co." />
        </div>
        <div class="form-group">
          <label>Your Address</label>
          <div class="flex gap-1">
            <input type="text" id="s-addr" placeholder="City, State" style="flex:1" />
            <button class="btn btn-secondary btn-sm" id="gps-btn" onclick="detectGPS('s-addr','gps-btn')" style="white-space:nowrap">üìç GPS</button>
          </div>
        </div>
        <button class="btn btn-primary btn-full" id="signup-btn" onclick="doSignup()">
          Create Account ‚Üí
        </button>
      </div>
    </div>
  </div>

  <div class="auth-footer">
    <p>By signing in you agree to our terms.<br>Built with Supabase ‚Ä¢ Deployed on GitHub Pages</p>
  </div>
</div>

<script src="assets/js/config.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/utils.js"></script>
<script>
// ‚îÄ‚îÄ ROLE PATHS ‚îÄ‚îÄ
const ROLE_PATHS = {
  buyer:    'buyer/',
  seller:   'seller/',
  delivery: 'delivery/',
  admin:    'admin/'
};

let selectedRole = 'buyer';

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
window.addEventListener('load', async () => {
  await new Promise(r => setTimeout(r, 1800));
  document.getElementById('loading-screen').style.opacity = '0';
  setTimeout(() => {
    document.getElementById('loading-screen').style.display = 'none';
    document.getElementById('auth-wrap').style.display = 'block';
    initPage();
  }, 600);
});

async function initPage() {
  const { url, key } = getCredentials();

  if (url && key) {
    const sb = await tryInitFromStorage();
    showConnectedStatus(url);
    if (sb) {
      // Check existing session
      const { data: { session } } = await sb.auth.getSession();
      if (session) {
        const { data: user } = await sb.from('users').select('role').eq('id', session.user.id).single();
        if (user) { window.location.href = ROLE_PATHS[user.role]; return; }
      }
    }
  } else {
    document.getElementById('sb-url').value = url || '';
    document.getElementById('sb-key').value = key || '';
  }
}

function showConnectedStatus(url) {
  const badge = document.getElementById('config-status-badge');
  const domain = url.replace('https://', '').split('.')[0];
  badge.innerHTML = `<div class="config-status connected">‚úÖ Connected to ${domain}.supabase.co</div>`;
  // Collapse config form
  document.getElementById('config-wrap').querySelector('.flex').style.display = 'none';
  document.getElementById('config-wrap').querySelector('.divider-text').style.display = 'none';
  document.getElementById('config-wrap').querySelector('.btn-ghost').style.display = 'none';
  // Add "change" link
  badge.innerHTML += `<button class="btn btn-ghost btn-xs" onclick="resetConfig()" style="font-size:11px">üîß Change</button>`;
}

function resetConfig() {
  clearCredentials();
  location.reload();
}

async function connectSupabase() {
  const url = document.getElementById('sb-url').value.trim();
  const key = document.getElementById('sb-key').value.trim();
  if (!url || !key) { toast('Please enter both URL and Key', 'error'); return; }
  if (!url.includes('supabase.co') && !url.includes('localhost')) { toast('URL should be a Supabase project URL', 'error'); return; }
  setBtn('connect-btn', true);
  try {
    await initSupabase(url, key);
    showConnectedStatus(url);
    toast('Database connected! ‚úÖ', 'success');
  } catch(e) {
    toast('Connection failed: ' + e.message, 'error');
  }
  setBtn('connect-btn', false, 'Connect Database');
}

// ‚îÄ‚îÄ DEMO MODE ‚îÄ‚îÄ
function enableDemo() {
  // Store a demo flag, then redirect to buyer
  sessionStorage.setItem('pr_demo', '1');
  sessionStorage.setItem('pr_demo_role', selectedRole);
  window.location.href = ROLE_PATHS[selectedRole];
}

// ‚îÄ‚îÄ ROLE SELECT ‚îÄ‚îÄ
function selectRole(el) {
  document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  selectedRole = el.dataset.role;
  document.getElementById('shop-field').style.display = selectedRole === 'seller' ? 'block' : 'none';
  // Hide signup for admin
  document.getElementById('tab-signup').style.display = selectedRole === 'admin' ? 'none' : '';
  if (selectedRole === 'admin' && document.getElementById('tab-signup').classList.contains('active')) {
    switchTab('login');
  }
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
function switchTab(tab) {
  document.getElementById('form-login').classList.toggle('hidden', tab !== 'login');
  document.getElementById('form-signup').classList.toggle('hidden', tab !== 'signup');
  document.getElementById('tab-login').classList.toggle('active', tab === 'login');
  document.getElementById('tab-signup').classList.toggle('active', tab === 'signup');
}

// ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ
async function doLogin() {
  if (!window.sb) { toast('Please connect to Supabase first', 'error'); return; }
  const email = document.getElementById('l-email').value.trim();
  const pass  = document.getElementById('l-pass').value;
  if (!email || !pass) { toast('Please fill in all fields', 'error'); return; }
  setBtn('login-btn', true);
  try {
    const { data, error } = await window.sb.auth.signInWithPassword({ email, password: pass });
    if (error) throw error;
    // Get user role
    const { data: user, error: ue } = await window.sb.from('users').select('role,is_banned').eq('id', data.user.id).single();
    if (ue || !user) throw new Error('Profile not found. Please sign up first.');
    if (user.is_banned) throw new Error('Account suspended. Contact support.');
    if (user.role !== selectedRole) {
      toast(`Signing you in as ${user.role}...`, 'info');
      setTimeout(() => { window.location.href = ROLE_PATHS[user.role]; }, 800);
      return;
    }
    toast('Welcome back! ‚úÖ', 'success');
    setTimeout(() => { window.location.href = ROLE_PATHS[user.role]; }, 600);
  } catch(e) {
    toast(e.message, 'error');
    setBtn('login-btn', false, 'Sign In ‚Üí');
  }
}

// ‚îÄ‚îÄ SIGNUP ‚îÄ‚îÄ
async function doSignup() {
  if (!window.sb) { toast('Please connect to Supabase first', 'error'); return; }
  const name  = document.getElementById('s-name').value.trim();
  const email = document.getElementById('s-email').value.trim();
  const pass  = document.getElementById('s-pass').value;
  const phone = document.getElementById('s-phone').value.trim();
  const addr  = document.getElementById('s-addr').value.trim();
  const shop  = document.getElementById('s-shop').value.trim();
  if (!name || !email || !pass) { toast('Name, email & password are required', 'error'); return; }
  if (pass.length < 8) { toast('Password must be at least 8 characters', 'error'); return; }
  if (selectedRole === 'seller' && !shop) { toast('Shop name is required for sellers', 'error'); return; }
  setBtn('signup-btn', true);
  try {
    // Create auth user
    const { data: authData, error: authErr } = await window.sb.auth.signUp({ email, password: pass });
    if (authErr) throw authErr;
    const uid = authData.user.id;
    // Insert profile
    const { error: profErr } = await window.sb.from('users').insert({
      id: uid, role: selectedRole, name, email, phone: phone||null, address: addr||null, is_verified: false, is_banned: false
    });
    if (profErr) throw profErr;
    // Insert seller record
    if (selectedRole === 'seller') {
      await window.sb.from('sellers').insert({ user_id: uid, shop_name: shop, verified_status: false });
    }
    toast('Account created! Check your email for verification. ‚úÖ', 'success');
    switchTab('login');
    document.getElementById('l-email').value = email;
  } catch(e) {
    toast(e.message, 'error');
  } finally { setBtn('signup-btn', false, 'Create Account ‚Üí'); }
}

// ‚îÄ‚îÄ FORGOT PASSWORD ‚îÄ‚îÄ
async function doForgotPassword() {
  const email = prompt('Enter your email address:');
  if (!email) return;
  if (!window.sb) { toast('Please connect to Supabase first', 'error'); return; }
  const { error } = await window.sb.auth.resetPasswordForEmail(email, {
    redirectTo: window.location.origin + '/index.html'
  });
  if (error) toast(error.message, 'error');
  else toast('Password reset email sent ‚úÖ', 'success');
}
</script>
</body>
</html>
