<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<meta name="theme-color" content="#0e0e07">
<title>Petal Rush ‚Äî Sign In</title>
<link rel="stylesheet" href="assets/css/styles.css">
<style>
body { display:flex; align-items:center; justify-content:center; min-height:100vh; padding:20px; }
.auth-page { width:100%; max-width:400px; position:relative; z-index:1; }

/* Brand */
.auth-brand { text-align:center; margin-bottom:32px; }
.auth-brand h1 { font-size:clamp(44px,10vw,66px); color:var(--gold); letter-spacing:0.06em; line-height:1; }
.auth-tagline { font-size:10px; letter-spacing:0.4em; text-transform:uppercase; color:var(--text-muted); margin-top:8px; }

/* Config banner */
.config-panel {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--r); padding:20px; margin-bottom:16px;
  transition:background 0.25s, border-color 0.25s;
}
.config-panel h3 { font-size:14px; font-weight:600; margin-bottom:4px; color:var(--text); }
.config-panel p { font-size:12px; color:var(--text-muted); margin-bottom:14px; line-height:1.55; }

.connected-badge {
  display:flex; align-items:center; gap:8px;
  padding:9px 12px; border-radius:8px; margin-bottom:10px;
  background:rgba(62,122,85,0.1); border:1px solid rgba(62,122,85,0.25);
  font-size:12px;
}
.conn-dot { width:8px; height:8px; border-radius:50%; background:var(--green-light); flex-shrink:0; }
.conn-text { flex:1; color:var(--text); }
.conn-change { font-size:11px; color:var(--text-muted); cursor:pointer; text-decoration:underline; }
.conn-change:hover { color:var(--gold); }

/* Auth card */
.auth-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--r); padding:28px;
  box-shadow:var(--shadow-lg);
  transition:background 0.25s, border-color 0.25s;
}

/* Role selector */
.role-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:5px; margin-bottom:22px; }
.role-btn {
  padding:10px 6px; border:1.5px solid var(--border);
  background:var(--surface2); border-radius:9px; cursor:pointer;
  color:var(--text-muted); font-family:'DM Sans',sans-serif;
  font-size:11px; font-weight:500; letter-spacing:0.03em;
  display:flex; flex-direction:column; align-items:center; gap:4px;
  transition:all 0.15s; -webkit-tap-highlight-color:transparent;
}
.role-btn .ri { font-size:20px; }
.role-btn:hover { border-color:var(--gold-light); color:var(--text); }
.role-btn.active { background:var(--gold-dim); color:var(--gold); border-color:rgba(201,168,76,0.40); }
[data-theme="light"] .role-btn.active { color:#8a6a10; }

/* Tabs */
.auth-tabs { display:flex; border-bottom:1px solid var(--border); margin-bottom:20px; }
.tab-btn {
  padding:9px 16px; border:none; background:none;
  color:var(--text-muted); font-family:'DM Sans',sans-serif; font-size:14px;
  cursor:pointer; position:relative; transition:color 0.18s;
}
.tab-btn.active { color:var(--gold); }
[data-theme="light"] .tab-btn.active { color:#8a6a10; }
.tab-btn.active::after { content:''; position:absolute; bottom:-1px; left:0; right:0; height:2px; background:var(--gold); border-radius:2px; }

/* Theme toggle top-right */
.auth-topbar { display:flex; justify-content:flex-end; margin-bottom:16px; }

/* Footer */
.auth-footer { text-align:center; margin-top:16px; }
.auth-footer p { font-size:11px; color:var(--text-muted); line-height:1.6; }

/* Error message */
.form-error { background:rgba(196,83,90,0.1); border:1px solid rgba(196,83,90,0.25); border-radius:8px; padding:10px 13px; font-size:13px; color:var(--rose-light); margin-bottom:14px; display:none; }

/* Password field */
.pass-wrap { position:relative; }
.pass-wrap input { padding-right:42px; }
.pass-toggle { position:absolute; right:12px; top:50%; transform:translateY(-50%); background:none; border:none; cursor:pointer; color:var(--text-muted); font-size:14px; padding:2px; }
.pass-toggle:hover { color:var(--text); }
</style>
</head>
<body>

<!-- Loading -->
<div id="loading-screen">
  <div class="ls-logo">Petal Rush</div>
  <div class="ls-sub">Premium Flower Marketplace</div>
  <div class="ls-bar"></div>
</div>

<div id="toast-root"></div>

<div class="auth-page hidden" id="auth-page">
  <!-- Theme toggle -->
  <div class="auth-topbar">
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">‚òÄÔ∏è</button>
  </div>

  <!-- Brand -->
  <div class="auth-brand">
    <h1>Petal Rush</h1>
    <div class="auth-tagline">Premium Flower Marketplace</div>
  </div>

  <!-- Supabase Config -->
  <div class="config-panel" id="config-panel">
    <h3>üîå Connect Database</h3>
    <p>Enter your Supabase project URL and API key to get started.</p>
    <div id="connected-state" style="display:none">
      <div class="connected-badge">
        <div class="conn-dot"></div>
        <span class="conn-text" id="conn-url-display">Connected</span>
        <span class="conn-change" onclick="disconnectDB()">Change</span>
      </div>
    </div>
    <div id="config-form">
      <div class="flex flex-col gap-2 mb-1">
        <div class="form-group">
          <label>Supabase Project URL</label>
          <input type="url" id="sb-url" placeholder="https://xxxx.supabase.co" autocomplete="off" spellcheck="false" />
        </div>
        <div class="form-group">
          <label>Anon Public Key</label>
          <input type="text" id="sb-key" placeholder="eyJhbGci‚Ä¶" autocomplete="off" spellcheck="false" />
        </div>
      </div>
      <button class="btn btn-primary btn-full" id="connect-btn" onclick="connectDB()">Connect ‚Üí</button>
    </div>
  </div>

  <!-- Auth Card -->
  <div class="auth-card" id="auth-card">
    <!-- Roles -->
    <div class="role-grid" id="role-grid">
      <button class="role-btn active" data-role="buyer" onclick="selectRole(this)"><span class="ri">üõçÔ∏è</span>Buyer</button>
      <button class="role-btn" data-role="seller" onclick="selectRole(this)"><span class="ri">üè™</span>Seller</button>
      <button class="role-btn" data-role="delivery" onclick="selectRole(this)"><span class="ri">üöö</span>Delivery</button>
      <button class="role-btn" data-role="admin" onclick="selectRole(this)"><span class="ri">üõ†Ô∏è</span>Admin</button>
    </div>

    <!-- Error display -->
    <div class="form-error" id="form-error"></div>

    <!-- Tabs -->
    <div class="auth-tabs" id="auth-tabs">
      <button class="tab-btn active" id="tab-login" onclick="switchTab('login')">Sign In</button>
      <button class="tab-btn" id="tab-signup" onclick="switchTab('signup')">Create Account</button>
    </div>

    <!-- LOGIN -->
    <div id="form-login">
      <div class="flex flex-col gap-2">
        <div class="form-group">
          <label>Email Address</label>
          <input type="email" id="l-email" placeholder="you@example.com" autocomplete="email" onkeydown="if(event.key==='Enter')doLogin()" />
        </div>
        <div class="form-group">
          <label>Password</label>
          <div class="pass-wrap">
            <input type="password" id="l-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()" />
            <button type="button" class="pass-toggle" onclick="togglePass('l-pass',this)">üëÅ</button>
          </div>
        </div>
        <button class="btn btn-primary btn-full mt-1" id="login-btn" onclick="doLogin()">Sign In ‚Üí</button>
        <button type="button" class="btn btn-ghost btn-sm" style="font-size:12px" onclick="forgotPass()">Forgot password?</button>
      </div>
    </div>

    <!-- SIGNUP -->
    <div id="form-signup" class="hidden">
      <div class="flex flex-col gap-2">
        <div class="form-row">
          <div class="form-group">
            <label>Full Name *</label>
            <input type="text" id="s-name" placeholder="Jane Rose" autocomplete="name" />
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" id="s-phone" placeholder="+91 98765‚Ä¶" autocomplete="tel" />
          </div>
        </div>
        <div class="form-group">
          <label>Email Address *</label>
          <input type="email" id="s-email" placeholder="you@example.com" autocomplete="email" />
        </div>
        <div class="form-group">
          <label>Password * (min 8 characters)</label>
          <div class="pass-wrap">
            <input type="password" id="s-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password" />
            <button type="button" class="pass-toggle" onclick="togglePass('s-pass',this)">üëÅ</button>
          </div>
        </div>
        <div class="form-group hidden" id="shop-field">
          <label>Shop Name *</label>
          <input type="text" id="s-shop" placeholder="Rose Garden Co." />
        </div>
        <div class="form-group">
          <label>Your Address</label>
          <div class="flex gap-1">
            <input type="text" id="s-addr" placeholder="City, State" style="flex:1" />
            <button class="btn btn-secondary btn-sm" id="s-gps" onclick="detectGPS('s-addr','s-gps')" style="flex-shrink:0">üìç</button>
          </div>
        </div>
        <button class="btn btn-primary btn-full" id="signup-btn" onclick="doSignup()">Create Account ‚Üí</button>
      </div>
    </div>
  </div>

  <div class="auth-footer">
    <p>Your data is stored securely in Supabase.</p>
  </div>
</div>

<script src="assets/js/config.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/utils.js"></script>
<script>
const ROLE_PATHS = { buyer:'buyer/', seller:'seller/', delivery:'delivery/', admin:'admin/' };
let selectedRole = 'buyer';
let isConnected = false;

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
window.addEventListener('load', async () => {
  applyTheme(localStorage.getItem(PR_THEME_KEY)||'dark');
  // Check for login msg
  const msg = sessionStorage.getItem('pr_login_msg');
  if (msg) { sessionStorage.removeItem('pr_login_msg'); }

  await new Promise(r => setTimeout(r, 1500));
  // Fade loading
  const ls = document.getElementById('loading-screen');
  ls.style.opacity = '0';
  setTimeout(() => { ls.style.display = 'none'; initPage(); }, 500);
});

async function initPage() {
  document.getElementById('auth-page').classList.remove('hidden');
  const { url, key } = getCredentials();
  if (url && key) {
    const sb = await tryInitFromStorage();
    if (sb) { showConnected(url); }
    else { showConfigForm(); }
  } else { showConfigForm(); }
  // Prefill credentials
  document.getElementById('sb-url').value = url;
  document.getElementById('sb-key').value = key;
}

function showConnected(url) {
  isConnected = true;
  const display = url.replace('https://','').split('.supabase.co')[0];
  document.getElementById('conn-url-display').textContent = `${display}.supabase.co`;
  document.getElementById('connected-state').style.display = '';
  document.getElementById('config-form').style.display = 'none';
  // Auto-check session
  checkExistingSession();
}

function showConfigForm() {
  isConnected = false;
  document.getElementById('connected-state').style.display = 'none';
  document.getElementById('config-form').style.display = '';
}

async function checkExistingSession() {
  if (!window.sb) return;
  try {
    const { data: { session } } = await window.sb.auth.getSession();
    if (session) {
      const { data: u } = await window.sb.from('users').select('role').eq('id', session.user.id).single();
      if (u?.role) { window.location.href = ROLE_PATHS[u.role]; }
    }
  } catch(e) {}
}

async function connectDB() {
  const url = document.getElementById('sb-url').value.trim();
  const key = document.getElementById('sb-key').value.trim();
  if (!url) { showErr('Please enter your Supabase URL'); return; }
  if (!key) { showErr('Please enter your Supabase Anon Key'); return; }
  if (!url.includes('supabase.co') && !url.startsWith('http')) { showErr('Please enter a valid Supabase URL (e.g. https://xxxx.supabase.co)'); return; }
  btnLoad('connect-btn', true, '‚è≥ Connecting‚Ä¶');
  clearErr();
  try {
    await initSupabase(url, key);
    // Test the connection
    const { error } = await window.sb.from('users').select('id').limit(1);
    if (error && error.code !== 'PGRST116') throw error;
    showConnected(url);
    toast('Database connected ‚úÖ', 'success');
  } catch(e) {
    showErr('Connection failed: ' + (e.message || 'Please check your URL and key'));
  }
  btnLoad('connect-btn', false);
}

function disconnectDB() {
  clearSupabase();
  showConfigForm();
  const { url, key } = getCredentials();
  document.getElementById('sb-url').value = url || '';
  document.getElementById('sb-key').value = key || '';
}

function selectRole(el) {
  document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  selectedRole = el.dataset.role;
  document.getElementById('shop-field').classList.toggle('hidden', selectedRole !== 'seller');
  // Admin cannot self-register
  if (selectedRole === 'admin') {
    document.getElementById('tab-signup').style.display = 'none';
    switchTab('login');
  } else {
    document.getElementById('tab-signup').style.display = '';
  }
}

function switchTab(tab) {
  document.getElementById('form-login').classList.toggle('hidden', tab !== 'login');
  document.getElementById('form-signup').classList.toggle('hidden', tab !== 'signup');
  document.getElementById('tab-login').classList.toggle('active', tab === 'login');
  document.getElementById('tab-signup').classList.toggle('active', tab === 'signup');
  clearErr();
}

function showErr(msg) {
  const el = document.getElementById('form-error');
  el.textContent = msg; el.style.display = '';
  el.scrollIntoView({ behavior:'smooth', block:'nearest' });
}
function clearErr() { document.getElementById('form-error').style.display = 'none'; }

function togglePass(id, btn) {
  const el = document.getElementById(id);
  const vis = el.type === 'text';
  el.type = vis ? 'password' : 'text';
  btn.textContent = vis ? 'üëÅ' : 'üôà';
}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
async function doLogin() {
  if (!isConnected) { showErr('Please connect to Supabase first'); return; }
  const email = document.getElementById('l-email').value.trim();
  const pass  = document.getElementById('l-pass').value;
  if (!email) { showErr('Please enter your email address'); return; }
  if (!pass)  { showErr('Please enter your password'); return; }
  btnLoad('login-btn', true, '‚è≥ Signing in‚Ä¶');
  clearErr();
  try {
    const { data, error } = await window.sb.auth.signInWithPassword({ email, password: pass });
    if (error) throw error;
    const { data: user, error: ue } = await window.sb.from('users').select('role,is_banned,name').eq('id', data.user.id).single();
    if (ue || !user) throw new Error('Account profile not found. Please sign up first.');
    if (user.is_banned) { await window.sb.auth.signOut(); throw new Error('Your account has been suspended. Contact support.'); }
    toast(`Welcome back, ${user.name}! ‚úÖ`, 'success');
    setTimeout(() => { window.location.href = ROLE_PATHS[user.role]; }, 700);
  } catch(e) {
    showErr(e.message);
    btnLoad('login-btn', false);
  }
}

/* ‚îÄ‚îÄ SIGNUP ‚îÄ‚îÄ */
async function doSignup() {
  if (!isConnected) { showErr('Please connect to Supabase first'); return; }
  const name  = document.getElementById('s-name').value.trim();
  const email = document.getElementById('s-email').value.trim();
  const pass  = document.getElementById('s-pass').value;
  const phone = document.getElementById('s-phone').value.trim();
  const addr  = document.getElementById('s-addr').value.trim();
  const shop  = document.getElementById('s-shop').value.trim();
  if (!name)  { showErr('Full name is required'); return; }
  if (!email) { showErr('Email address is required'); return; }
  if (!pass || pass.length < 8) { showErr('Password must be at least 8 characters'); return; }
  if (selectedRole === 'seller' && !shop) { showErr('Shop name is required for sellers'); return; }
  btnLoad('signup-btn', true, '‚è≥ Creating account‚Ä¶');
  clearErr();
  try {
    const { data: authData, error: authErr } = await window.sb.auth.signUp({ email, password: pass });
    if (authErr) throw authErr;
    if (!authData.user) throw new Error('Account creation failed. Please try again.');
    const uid = authData.user.id;
    const { error: profErr } = await window.sb.from('users').insert({
      id: uid, role: selectedRole, name, email,
      phone: phone||null, address: addr||null
    });
    if (profErr) throw profErr;
    if (selectedRole === 'seller') {
      await window.sb.from('sellers').insert({ user_id: uid, shop_name: shop });
    }
    toast('Account created! Please check your email to verify. ‚úÖ', 'success');
    setTimeout(() => { switchTab('login'); document.getElementById('l-email').value = email; }, 1200);
  } catch(e) {
    showErr(e.message);
  } finally { btnLoad('signup-btn', false); }
}

async function forgotPass() {
  const email = document.getElementById('l-email').value.trim() || prompt('Enter your email address:');
  if (!email) return;
  if (!isConnected) { showErr('Please connect to Supabase first'); return; }
  const { error } = await window.sb.auth.resetPasswordForEmail(email, { redirectTo: location.origin + '/index.html' });
  if (error) showErr(error.message);
  else toast('Password reset email sent! Check your inbox ‚úÖ', 'success');
}
</script>
</body>
</html>
