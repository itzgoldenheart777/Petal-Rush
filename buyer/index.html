<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Petal Rush ‚Äî Buyer</title>
<link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body>
<div id="loading-screen">
  <div class="loading-logo">Petal Rush</div>
  <div class="loading-sub">Buyer Dashboard</div>
  <div class="loading-bar"></div>
</div>
<div id="toast-container"></div>

<div class="dashboard-wrap hidden" id="app">
  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <h1>Petal Rush</h1>
      <div class="sidebar-role-tag">üõçÔ∏è Buyer</div>
    </div>
    <div class="sidebar-user" onclick="showPanel('profile')">
      <div id="sb-avatar"></div>
      <div class="sidebar-user-info">
        <div class="sidebar-user-name" id="sb-name">Loading‚Ä¶</div>
        <div class="sidebar-user-email" id="sb-email">‚Ä¶</div>
      </div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">Shopping</div>
      <button class="nav-item active" data-panel="shop" onclick="showPanel('shop')">
        <span class="nav-icon">üå∏</span> Browse Shop
      </button>
      <button class="nav-item" data-panel="orders" onclick="showPanel('orders')">
        <span class="nav-icon">üì¶</span> My Orders
        <span class="nav-badge" id="orders-badge" style="display:none"></span>
      </button>
      <div class="nav-section">Account</div>
      <button class="nav-item" data-panel="profile" onclick="showPanel('profile')">
        <span class="nav-icon">üë§</span> My Profile
      </button>
    </nav>
    <div class="sidebar-footer">
      <button class="nav-item w-full" onclick="logout()">
        <span class="nav-icon">üö™</span> Sign Out
      </button>
    </div>
  </nav>

  <!-- Topbar (mobile) -->
  <div class="topbar">
    <button class="topbar-menu" onclick="toggleSidebar()">‚ò∞</button>
    <div class="topbar-brand">Petal Rush</div>
    <div id="topbar-avatar" onclick="showPanel('profile')" style="cursor:pointer"></div>
  </div>

  <main class="main-content">
    <!-- ‚ïê‚ïê‚ïê SHOP PANEL ‚ïê‚ïê‚ïê -->
    <div class="panel active" id="panel-shop">
      <div class="page-header">
        <div>
          <h2>Browse <em>Flowers</em></h2>
          <div class="page-breadcrumb">Fresh blooms, delivered to your door</div>
        </div>
      </div>
      <div class="search-bar">
        <div class="search-wrap">
          <span class="s-icon">üîç</span>
          <input type="text" id="search-q" placeholder="Search roses, orchids, bouquets‚Ä¶" oninput="filterProducts()" />
        </div>
        <select id="search-cat" onchange="filterProducts()" style="width:150px">
          <option value="">All Categories</option>
          <option value="flowers">üå∏ Flowers</option>
          <option value="bouquets">üíê Bouquets</option>
          <option value="plants">ü™¥ Plants</option>
          <option value="gifts">üéÅ Gift Sets</option>
        </select>
        <select id="search-sort" onchange="filterProducts()" style="width:140px">
          <option value="newest">Newest</option>
          <option value="price-asc">Price: Low‚ÜíHigh</option>
          <option value="price-desc">Price: High‚ÜíLow</option>
        </select>
      </div>
      <div class="products-grid" id="shop-grid">
        <div class="empty-state" style="grid-column:1/-1">
          <div class="es-icon">‚è≥</div><h3>Loading products‚Ä¶</h3>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê ORDERS PANEL ‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-orders">
      <div class="page-header">
        <div><h2>My <em>Orders</em></h2></div>
      </div>
      <div id="orders-list">
        <div class="empty-state"><div class="es-icon">‚è≥</div><h3>Loading‚Ä¶</h3></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PROFILE PANEL ‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-profile">
      <div class="page-header">
        <div><h2>My <em>Profile</em></h2></div>
      </div>
      <div class="profile-wrap">
        <div class="profile-card mb-2">
          <div class="profile-cover">
            <div class="profile-avatar-wrap" id="profile-avatar-container">
              <!-- Rendered by JS -->
            </div>
          </div>
          <div class="profile-info">
            <div class="profile-name" id="profile-name-display">‚Äî</div>
            <div class="profile-role">üõçÔ∏è Buyer</div>
            <p class="text-muted text-sm mt-1" style="font-size:12px">Click your photo above to upload a new avatar</p>
          </div>
        </div>
        <div class="card mb-2">
          <div class="card-header"><h3>Personal Information</h3></div>
          <div class="flex flex-col gap-2">
            <div class="form-row">
              <div class="form-group"><label>Full Name</label><input type="text" id="p-name" /></div>
              <div class="form-group"><label>Phone</label><input type="tel" id="p-phone" /></div>
            </div>
            <div class="form-group"><label>Email</label><input type="email" id="p-email" disabled /></div>
            <div class="form-group">
              <label>Default Delivery Address</label>
              <div class="flex gap-1">
                <input type="text" id="p-addr" placeholder="Your delivery address" style="flex:1" />
                <button class="btn btn-secondary btn-sm" id="p-gps-btn" onclick="detectGPS('p-addr','p-gps-btn')">üìç GPS</button>
              </div>
            </div>
            <button class="btn btn-primary" id="save-profile-btn" onclick="saveProfile()">Save Changes</button>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><h3>Security</h3></div>
          <button class="btn btn-secondary btn-full" onclick="doResetPassword()">üîë Change Password</button>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- ‚ïê‚ïê‚ïê PRODUCT DETAIL MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay hidden" id="product-modal">
  <div class="modal">
    <div class="modal-header">
      <h3 id="pm-name">Product</h3>
      <button class="modal-close" onclick="document.getElementById('product-modal').classList.add('hidden')">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="pm-img" style="height:200px;background:var(--bg3);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:64px;margin-bottom:16px;overflow:hidden"></div>
      <p id="pm-desc" class="text-muted mb-2" style="font-size:13px;line-height:1.6"></p>
      <div class="flex justify-between items-center mb-2">
        <div style="font-family:'Cormorant Garamond',serif;font-size:28px;color:var(--gold)" id="pm-price"></div>
        <div class="text-muted text-xs" id="pm-qty"></div>
      </div>
      <div class="flex flex-col gap-2">
        <div class="form-row">
          <div class="form-group">
            <label>Quantity</label>
            <input type="number" id="pm-qty-input" value="1" min="1" max="99" />
          </div>
          <div class="form-group">
            <label>Payment</label>
            <select id="pm-payment">
              <option value="online">üí≥ Online</option>
              <option value="cod">üíµ Cash on Delivery</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Delivery Address</label>
          <div class="flex gap-1">
            <input type="text" id="pm-addr" placeholder="Enter delivery address" style="flex:1" />
            <button class="btn btn-secondary btn-sm" id="pm-gps" onclick="detectGPS('pm-addr','pm-gps')">üìç</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="document.getElementById('product-modal').classList.add('hidden')">Cancel</button>
      <button class="btn btn-primary" id="place-order-btn" onclick="placeOrder()">üõí Place Order</button>
    </div>
  </div>
</div>

<script src="../assets/js/config.js"></script>
<script src="../assets/js/auth.js"></script>
<script src="../assets/js/utils.js"></script>
<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let USER = null;
let ALL_PRODUCTS = [];
let SELECTED_PRODUCT = null;

// Permanently disabled demo for production
const DEMO = false; 

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
window.addEventListener('load', async () => {
  await delay(1600);
  hideSplash();
  await initDashboard();
});

async function initDashboard() {
  // PRODUCTION: Always verify real Supabase Auth
  USER = await requireRole('buyer'); 
  if (!USER) return;
  
  renderUser();
  document.getElementById('app').classList.remove('hidden');
  showPanel('shop');
}

function renderUser() {
  document.getElementById('sb-name').textContent  = USER.name || 'Buyer';
  document.getElementById('sb-email').textContent = USER.email || '';
  document.getElementById('sb-avatar').innerHTML  = renderAvatar(USER, 'avatar-md');
  document.getElementById('topbar-avatar').innerHTML = renderAvatar(USER, 'avatar-sm');
}

// ‚îÄ‚îÄ PANEL SHOW ‚îÄ‚îÄ
const PANELS = ['shop','orders','profile'];
function showPanel(id) {
  PANELS.forEach(p => {
    document.getElementById(`panel-${p}`)?.classList.toggle('active', p === id);
    document.getElementById(`panel-${p}`)?.classList.toggle('hidden', p !== id);
  });
  setActiveNav(id);
  closeSidebar();
  loadPanel(id);
}

async function loadPanel(id) {
  if (id === 'shop')    await loadShop();
  if (id === 'orders')  await loadOrders();
  if (id === 'profile') loadProfileForm();
}

// ‚îÄ‚îÄ SHOP ‚îÄ‚îÄ
async function loadShop() {
  // PRODUCTION: Fetch real active products from database
  const { data, error } = await window.sb.from('products')
    .select('*')
    .eq('is_active', true)
    .gt('quantity', 0) // Only show items in stock
    .order('created_at', { ascending:false });
    
  if (error) {
    toast("Error loading shop: " + error.message, "error");
    return;
  }
  ALL_PRODUCTS = data || [];
  renderProducts(ALL_PRODUCTS);
}

function renderProducts(products) {
  const grid = document.getElementById('shop-grid');
  if (!products.length) {
    grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><div class="es-icon">üå∏</div><h3>No products available</h3><p>Check back soon!</p></div>`;
    return;
  }
  grid.innerHTML = products.map(p => `
    <div class="product-card">
      <div class="product-img">
        ${p.image_url ? `<img src="${p.image_url}" alt="${p.name}" onerror="this.parentElement.innerHTML='${prodEmoji(p.category)}'" />` : prodEmoji(p.category)}
        <span class="product-cat-badge">${p.category||'flower'}</span>
      </div>
      <div class="product-body">
        <div class="product-name">${p.name}</div>
        <div class="product-desc">${p.description||'Beautiful, fresh flowers'}</div>
        <div class="product-footer">
          <div class="product-price"><sup>‚Çπ</sup>${Number(p.price).toLocaleString('en-IN')}</div>
          <div class="product-qty">${p.quantity} left</div>
        </div>
      </div>
      <div class="product-actions">
        <button class="btn btn-primary btn-sm w-full" onclick="openProductModal('${p.id}')">üõí Order Now</button>
      </div>
    </div>`).join('');
}

// ‚îÄ‚îÄ PRODUCT MODAL & ORDERING ‚îÄ‚îÄ
function openProductModal(id) {
  SELECTED_PRODUCT = ALL_PRODUCTS.find(p => p.id === id);
  if (!SELECTED_PRODUCT) return;
  const p = SELECTED_PRODUCT;
  document.getElementById('pm-name').textContent  = p.name;
  document.getElementById('pm-desc').textContent  = p.description || '';
  document.getElementById('pm-price').textContent = `‚Çπ${Number(p.price).toLocaleString('en-IN')}`;
  document.getElementById('pm-qty').textContent   = `${p.quantity} in stock`;
  document.getElementById('pm-addr').value = USER.address || '';
  document.getElementById('pm-qty-input').value = '1';
  
  const imgEl = document.getElementById('pm-img');
  imgEl.innerHTML = p.image_url
    ? `<img src="${p.image_url}" style="width:100%;height:100%;object-fit:cover" onerror="this.parentElement.innerHTML='${prodEmoji(p.category)}'" />`
    : prodEmoji(p.category);
  document.getElementById('product-modal').classList.remove('hidden');
}

async function placeOrder() {
  if (!SELECTED_PRODUCT) return;
  const qty    = parseInt(document.getElementById('pm-qty-input').value) || 1;
  const addr   = document.getElementById('pm-addr').value.trim();
  const ptype  = document.getElementById('pm-payment').value;

  if (!addr) { toast('Delivery address is required', 'error'); return; }
  if (qty < 1 || qty > SELECTED_PRODUCT.quantity) {
    toast(`Please enter quantity between 1 and ${SELECTED_PRODUCT.quantity}`, 'error'); return;
  }

  setBtn('place-order-btn', true);
  try {
    const total = SELECTED_PRODUCT.price * qty;
    
    // PRODUCTION: Insert real order into Supabase
    const { data: order, error } = await window.sb.from('orders').insert({
      buyer_id: USER.id, 
      seller_id: SELECTED_PRODUCT.seller_id,
      product_id: SELECTED_PRODUCT.id, 
      quantity: qty,
      total_amount: total, 
      drop_address: addr,
      payment_type: ptype,
      order_status: 'placed',
      payment_status: ptype === 'online' ? 'paid' : 'pending'
    }).select().single();

    if (error) throw error;

    // Create real payment record
    await window.sb.from('payments').insert({
      order_id: order.id, 
      seller_id: SELECTED_PRODUCT.seller_id,
      buyer_id: USER.id, 
      amount: total,
      status: ptype === 'online' ? 'admin_wallet' : 'pending',
      payment_method: ptype
    });

    // Update product stock in database
    await window.sb.from('products')
      .update({ quantity: SELECTED_PRODUCT.quantity - qty })
      .eq('id', SELECTED_PRODUCT.id);

    toast(`‚úÖ Order placed! Total: ‚Çπ${total.toLocaleString('en-IN')}`, 'success');
    document.getElementById('product-modal').classList.add('hidden');
    SELECTED_PRODUCT = null;
    loadShop(); // Refresh shop view
  } catch(e) { 
    toast(e.message, 'error'); 
  } finally { 
    setBtn('place-order-btn', false, 'üõí Place Order'); 
  }
}

// ‚îÄ‚îÄ ORDERS ‚îÄ‚îÄ
async function loadOrders() {
  // PRODUCTION: Join products to get names
  const { data, error } = await window.sb
    .from('orders')
    .select('*, products(name, category)')
    .eq('buyer_id', USER.id)
    .order('created_at', { ascending:false });

  if (error) {
    toast("Error loading orders: " + error.message, "error");
    return;
  }
  renderOrders(data || []);
}

function renderOrders(orders) {
  const el = document.getElementById('orders-list');
  if (!orders.length) {
    el.innerHTML = `<div class="empty-state"><div class="es-icon">üì≠</div><h3>No orders yet</h3><p>Browse the shop and place your first order!</p></div>`;
    return;
  }

  const active = orders.filter(o => !['delivered','returned','cancelled'].includes(o.order_status));
  const badge = document.getElementById('orders-badge');
  if (active.length) { 
    badge.textContent = active.length; 
    badge.style.display = ''; 
  } else {
    badge.style.display = 'none';
  }

  el.innerHTML = orders.map(o => `
    <div class="order-card">
      <div class="order-header">
        <div>
          <div class="order-id">${shortId(o.id)}</div>
          <div class="order-product">${o.products?.name || 'Product'}</div>
        </div>
        <div>${statusBadge(o.order_status)}</div>
      </div>
      <div class="order-meta">
        <div class="order-row"><span class="order-label">Amount</span><span class="order-value text-gold">${fmtCurrency(o.total_amount)}</span></div>
        <div class="order-row"><span class="order-label">Payment</span>${paymentBadge(o.payment_type)}</div>
        <div class="order-row"><span class="order-label">Deliver to</span><span class="order-value">${o.drop_address||'‚Äî'}</span></div>
      </div>
    </div>`).join('');
}

// ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ
async function saveProfile() {
  const name  = document.getElementById('p-name').value.trim();
  const phone = document.getElementById('p-phone').value.trim();
  const addr  = document.getElementById('p-addr').value.trim();
  
  if (!name) { toast('Name is required', 'error'); return; }
  setBtn('save-profile-btn', true);

  try {
    const { error } = await window.sb.from('users')
      .update({ name, phone, address: addr })
      .eq('id', USER.id);
      
    if (error) throw error;
    
    USER.name = name;
    USER.phone = phone;
    USER.address = addr;
    renderUser();
    document.getElementById('profile-name-display').textContent = name;
    toast('Profile saved ‚úÖ', 'success');
  } catch(e) { 
    toast(e.message, 'error'); 
  } finally { 
    setBtn('save-profile-btn', false, 'Save Changes'); 
  }
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function delay(ms) { return new Promise(r => setTimeout(r, ms)); }
function hideSplash() {
  const s = document.getElementById('loading-screen');
  s.style.opacity = '0';
  setTimeout(() => s.style.display = 'none', 600);
}

// Global UI override
window.showPanel = function(id) {
  ['shop','orders','profile'].forEach(p => {
    const el = document.getElementById(`panel-${p}`);
    if (el) el.classList.toggle('active', p === id);
  });
  setActiveNav(id);
  closeSidebar();
  loadPanel(id);
};


</script>
</body>
</html>
