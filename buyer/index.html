<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Petal Rush â€” Buyer</title>
<link rel="stylesheet" href="../assets/css/styles.css">
<style>
.panel { display:none; }
.panel.active { display:block; }

/* Product detail in modal */
.pm-img { height:180px; background:var(--bg3); border-radius:9px; display:flex; align-items:center; justify-content:center; font-size:60px; margin-bottom:14px; overflow:hidden; }
.pm-img img { width:100%; height:100%; object-fit:cover; }

/* Order status timeline */
.status-steps { display:flex; align-items:center; gap:0; margin:12px 0; flex-wrap:wrap; }
.status-step { display:flex; align-items:center; gap:4px; font-size:11px; flex-shrink:0; }
.status-step .dot { width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; flex-shrink:0; }
.status-step .dot.done   { background:var(--gold-dim); border:1.5px solid var(--gold); }
.status-step .dot.active { background:var(--gold); color:#000; }
.status-step .dot.pending{ background:var(--surface2); border:1.5px solid var(--border); color:var(--text-muted); }
.status-step .line { width:24px; height:1.5px; background:var(--border); }
.status-step .line.done { background:var(--gold); }
</style>
</head>
<body>
<div id="loading-screen"><div class="ls-logo">Petal Rush</div><div class="ls-sub">Buyer Dashboard</div><div class="ls-bar"></div></div>
<div id="toast-root"></div>

<div class="dash-wrap hidden" id="app">
  <div class="sidebar-overlay" id="sb-overlay" onclick="closeSidebar()"></div>

  <nav class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <h1>Petal Rush</h1>
      <div class="sidebar-role">ğŸ›ï¸ Buyer</div>
    </div>
    <div class="sidebar-user" id="sb-user" onclick="navTo('profile')">
      <div id="sb-av"></div>
      <div class="sidebar-user-info">
        <div class="sidebar-user-name" id="sb-name">Loadingâ€¦</div>
        <div class="sidebar-user-email" id="sb-email">â€¦</div>
      </div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">Shopping</div>
      <button class="nav-item active" data-panel="shop" onclick="navTo('shop')"><span class="nav-icon">ğŸŒ¸</span>Browse Shop</button>
      <button class="nav-item" data-panel="orders" onclick="navTo('orders')"><span class="nav-icon">ğŸ“¦</span>My Orders<span class="nav-badge hidden" id="ord-badge">0</span></button>
      <div class="nav-section">Account</div>
      <button class="nav-item" data-panel="profile" onclick="navTo('profile')"><span class="nav-icon">ğŸ‘¤</span>My Profile</button>
    </nav>
    <div class="sidebar-footer">
      <button class="nav-item" style="color:var(--rose-light)" onclick="logout()"><span class="nav-icon">ğŸšª</span>Sign Out</button>
    </div>
  </nav>

  <div class="topbar">
    <div class="topbar-left">
      <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
      <div class="topbar-brand">Petal Rush</div>
    </div>
    <div class="topbar-right">
      <button class="theme-toggle" onclick="toggleTheme()">â˜€ï¸</button>
      <div id="top-av" onclick="navTo('profile')" style="cursor:pointer"></div>
    </div>
  </div>

  <main class="main-content">

    <!-- â”€â”€ SHOP â”€â”€ -->
    <div class="panel active" id="panel-shop">
      <div class="page-header">
        <div class="page-header-left"><h2>Browse <em>Shop</em></h2><div class="page-sub">Fresh blooms, delivered to you</div></div>
      </div>
      <div class="search-bar">
        <div class="search-wrap"><span class="search-icon">ğŸ”</span><input type="text" id="q" placeholder="Search roses, orchids, bouquetsâ€¦" oninput="filterProds()" /></div>
        <select id="cat-filter" onchange="filterProds()" style="width:140px">
          <option value="">All Categories</option>
          <option value="flowers">ğŸŒ¸ Flowers</option>
          <option value="bouquets">ğŸ’ Bouquets</option>
          <option value="plants">ğŸª´ Plants</option>
          <option value="gifts">ğŸ Gifts</option>
        </select>
        <select id="sort" onchange="filterProds()" style="width:140px">
          <option value="">Sort: Newest</option>
          <option value="asc">Price: Low â†’ High</option>
          <option value="desc">Price: High â†’ Low</option>
        </select>
      </div>
      <div class="products-grid" id="shop-grid">
        <div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">â³</div><h3>Loading productsâ€¦</h3></div>
      </div>
    </div>

    <!-- â”€â”€ ORDERS â”€â”€ -->
    <div class="panel" id="panel-orders">
      <div class="page-header">
        <div class="page-header-left"><h2>My <em>Orders</em></h2></div>
      </div>
      <div id="orders-list"><div class="empty-state"><div class="empty-icon">â³</div><h3>Loadingâ€¦</h3></div></div>
    </div>

    <!-- â”€â”€ PROFILE â”€â”€ -->
    <div class="panel" id="panel-profile">
      <div class="page-header"><div class="page-header-left"><h2>My <em>Profile</em></h2></div></div>
      <div class="profile-wrap">
        <div class="profile-card mb-2">
          <div class="profile-cover">
            <div class="profile-cover-av" id="prof-av-wrap"></div>
          </div>
          <div class="profile-info">
            <div class="profile-name" id="prof-name">â€”</div>
            <div class="profile-role-badge">ğŸ›ï¸ Buyer</div>
            <p class="profile-hint">Tap your photo to upload a new avatar</p>
          </div>
        </div>
        <div class="card mb-2">
          <div class="card-header"><h3>Personal Information</h3></div>
          <div class="flex flex-col gap-2">
            <div class="form-row">
              <div class="form-group"><label>Full Name</label><input type="text" id="p-name" /></div>
              <div class="form-group"><label>Phone</label><input type="tel" id="p-phone" /></div>
            </div>
            <div class="form-group"><label>Email</label><input type="email" id="p-email" disabled /></div>
            <div class="form-group">
              <label>Default Delivery Address</label>
              <div class="flex gap-1">
                <input type="text" id="p-addr" placeholder="Enter your address" style="flex:1" />
                <button class="btn btn-secondary btn-sm" id="p-gps" onclick="detectGPS('p-addr','p-gps')" style="flex-shrink:0">ğŸ“ GPS</button>
              </div>
            </div>
            <button class="btn btn-primary" id="save-btn" onclick="saveProfile()">Save Changes</button>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><h3>Security</h3></div>
          <button class="btn btn-secondary btn-full" onclick="resetPass()">ğŸ”‘ Change Password</button>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- Product Modal -->
<div class="modal-overlay hidden" id="prod-modal">
  <div class="modal">
    <div class="modal-header">
      <h3 id="pm-name">Product</h3>
      <button class="modal-close" onclick="closeModal('prod-modal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="pm-img" id="pm-img"></div>
      <p id="pm-desc" class="text-muted text-sm mb-2" style="line-height:1.6"></p>
      <div class="flex justify-between items-center mb-2">
        <div style="font-family:'Cormorant Garamond',serif;font-size:26px;color:var(--gold)" id="pm-price"></div>
        <div class="text-muted text-xs" id="pm-stock"></div>
      </div>
      <div class="flex flex-col gap-2">
        <div class="form-row">
          <div class="form-group"><label>Quantity</label><input type="number" id="pm-qty" value="1" min="1" /></div>
          <div class="form-group"><label>Payment</label>
            <select id="pm-pay">
              <option value="online">ğŸ’³ Online</option>
              <option value="cod">ğŸ’µ Cash on Delivery</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Delivery Address *</label>
          <div class="flex gap-1">
            <input type="text" id="pm-addr" placeholder="Enter delivery address" style="flex:1" />
            <button class="btn btn-secondary btn-sm" id="pm-gps" onclick="detectGPS('pm-addr','pm-gps')" style="flex-shrink:0">ğŸ“</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('prod-modal')">Cancel</button>
      <button class="btn btn-primary" id="order-btn" onclick="placeOrder()">ğŸ›’ Place Order</button>
    </div>
  </div>
</div>

<script src="../assets/js/config.js"></script>
<script src="../assets/js/auth.js"></script>
<script src="../assets/js/utils.js"></script>
<script>
let USER = null, ALL_PRODS = [], SEL_PROD = null;

window.addEventListener('load', async () => {
  applyTheme(localStorage.getItem(PR_THEME_KEY)||'dark');
  await sleep(1500); hideSplash();
  USER = await requireRole('buyer');
  if (!USER) return;
  renderUser();
  document.getElementById('app').classList.remove('hidden');
  navTo('shop');
});

function renderUser() {
  document.getElementById('sb-name').textContent  = USER.name;
  document.getElementById('sb-email').textContent = USER.email;
  document.getElementById('sb-av').innerHTML  = renderAvatar(USER,'av-md');
  document.getElementById('top-av').innerHTML = renderAvatar(USER,'av-sm');
}

function navTo(id) {
  ['shop','orders','profile'].forEach(p => {
    const el = document.getElementById(`panel-${p}`);
    if (el) el.style.display = p === id ? '' : 'none';
  });
  setActiveNav(id);
  closeSidebar();
  if (id==='shop')    loadShop();
  if (id==='orders')  loadOrders();
  if (id==='profile') loadProfile();
}
// Override global
window.showPanel = navTo;

/* â”€â”€ SHOP â”€â”€ */
async function loadShop() {
  const grid = document.getElementById('shop-grid');
  grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">â³</div><h3>Loadingâ€¦</h3></div>`;
  const { data, error } = await window.sb.from('products').select('*').eq('is_active',true).order('created_at',{ascending:false});
  if (error) { grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">âš ï¸</div><h3>${error.message}</h3></div>`; return; }
  ALL_PRODS = data || [];
  renderProds(ALL_PRODS);
}

function renderProds(list) {
  const grid = document.getElementById('shop-grid');
  if (!list.length) {
    grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">ğŸŒ¸</div><h3>No products available</h3><p>Check back soon for fresh blooms!</p></div>`;
    return;
  }
  grid.innerHTML = list.map(p => `
    <div class="product-card">
      <div class="product-img">
        ${p.image_url ? `<img src="${p.image_url}" alt="${p.name}" loading="lazy" onerror="this.parentElement.innerHTML='${prodEmoji(p.category)}'" />` : prodEmoji(p.category)}
        <span class="product-cat">${p.category||'flower'}</span>
      </div>
      <div class="product-body">
        <div class="product-name">${p.name}</div>
        <div class="product-desc">${p.description||'Beautiful fresh flowers'}</div>
        <div class="product-footer">
          <div><div class="product-price">â‚¹${Number(p.price).toLocaleString('en-IN')}</div><div class="product-qty">${p.quantity} in stock</div></div>
        </div>
      </div>
      <div class="product-actions">
        <button class="btn btn-primary btn-sm w-full" onclick="openProdModal('${p.id}')" ${p.quantity<1?'disabled':''}>
          ${p.quantity<1?'Out of Stock':'ğŸ›’ Order Now'}
        </button>
      </div>
    </div>`).join('');
}

function filterProds() {
  const q   = document.getElementById('q').value.toLowerCase();
  const cat = document.getElementById('cat-filter').value;
  const srt = document.getElementById('sort').value;
  let list = ALL_PRODS.filter(p =>
    (!q || p.name.toLowerCase().includes(q) || (p.description||'').toLowerCase().includes(q)) &&
    (!cat || p.category === cat)
  );
  if (srt==='asc')  list.sort((a,b)=>a.price-b.price);
  if (srt==='desc') list.sort((a,b)=>b.price-a.price);
  renderProds(list);
}

/* â”€â”€ PRODUCT MODAL â”€â”€ */
function openProdModal(id) {
  SEL_PROD = ALL_PRODS.find(p=>p.id===id);
  if (!SEL_PROD) return;
  const p = SEL_PROD;
  document.getElementById('pm-name').textContent  = p.name;
  document.getElementById('pm-desc').textContent  = p.description||'';
  document.getElementById('pm-price').textContent = `â‚¹${Number(p.price).toLocaleString('en-IN')}`;
  document.getElementById('pm-stock').textContent = `${p.quantity} in stock`;
  document.getElementById('pm-qty').max = p.quantity;
  document.getElementById('pm-addr').value = USER.address||'';
  document.getElementById('pm-qty').value  = '1';
  const imgEl = document.getElementById('pm-img');
  imgEl.innerHTML = p.image_url
    ? `<img src="${p.image_url}" alt="${p.name}" onerror="this.parentElement.innerHTML='${prodEmoji(p.category)}'" />`
    : prodEmoji(p.category);
  document.getElementById('prod-modal').classList.remove('hidden');
}

async function placeOrder() {
  if (!SEL_PROD) return;
  const qty   = parseInt(document.getElementById('pm-qty').value)||1;
  const addr  = document.getElementById('pm-addr').value.trim();
  const ptype = document.getElementById('pm-pay').value;
  if (!addr) { toast('Please enter a delivery address', 'error'); return; }
  if (qty < 1 || qty > SEL_PROD.quantity) { toast(`Quantity must be between 1 and ${SEL_PROD.quantity}`, 'error'); return; }
  btnLoad('order-btn', true, 'â³ Placing orderâ€¦');
  try {
    const total = SEL_PROD.price * qty;
    const { data: order, error } = await window.sb.from('orders').insert({
      buyer_id: USER.id, seller_id: SEL_PROD.seller_id, product_id: SEL_PROD.id,
      quantity: qty, total_amount: total, drop_address: addr,
      payment_type: ptype, order_status: 'placed',
      payment_status: ptype==='online' ? 'paid' : 'pending'
    }).select().single();
    if (error) throw error;
    await window.sb.from('payments').insert({
      order_id: order.id, seller_id: SEL_PROD.seller_id, buyer_id: USER.id,
      amount: total, status: ptype==='online' ? 'admin_wallet' : 'pending', payment_method: ptype
    });
    await window.sb.from('products').update({ quantity: SEL_PROD.quantity - qty }).eq('id', SEL_PROD.id);
    toast(`Order placed! Total: â‚¹${total.toLocaleString('en-IN')} âœ…`, 'success');
    closeModal('prod-modal'); SEL_PROD = null;
    ALL_PRODS = ALL_PRODS.map(p => p.id === order.product_id ? {...p, quantity: p.quantity-qty} : p);
    renderProds(ALL_PRODS);
  } catch(e) { toast(e.message, 'error'); }
  finally { btnLoad('order-btn', false); }
}

/* â”€â”€ ORDERS â”€â”€ */
async function loadOrders() {
  const el = document.getElementById('orders-list');
  const { data, error } = await window.sb.from('orders').select('*, products(name,category)').eq('buyer_id',USER.id).order('created_at',{ascending:false});
  if (error) { el.innerHTML = `<div class="alert alert-error">${error.message}</div>`; return; }
  const orders = data || [];
  // Update badge
  const active = orders.filter(o=>!['delivered','returned','cancelled'].includes(o.order_status));
  const badge = document.getElementById('ord-badge');
  if (active.length) { badge.textContent = active.length; badge.classList.remove('hidden'); }
  else badge.classList.add('hidden');
  if (!orders.length) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“­</div><h3>No orders yet</h3><p>Browse our shop and place your first order!</p><button class="btn btn-primary mt-2" onclick="navTo('shop')">Browse Shop â†’</button></div>`;
    return;
  }
  const STEPS = ['placed','assigned','picked','delivered'];
  el.innerHTML = orders.map(o => {
    const status = o.order_status;
    const si = STEPS.indexOf(status);
    const timeline = status !== 'returned' && status !== 'cancelled' ? `
      <div class="status-steps">
        ${STEPS.map((s,i) => `
          <div class="status-step">
            <div class="dot ${i < si ? 'done' : i === si ? 'active' : 'pending'}">${['ğŸ•','ğŸ‘¤','ğŸ“¦','âœ…'][i]}</div>
            ${i < STEPS.length-1 ? `<div class="line ${i < si ? 'done':''}"></div>` : ''}
          </div>`).join('')}
      </div>` : '';
    return `
    <div class="order-card">
      <div class="order-header">
        <div>
          <div class="order-id">${shortId(o.id)}</div>
          <div class="order-name">${o.products?.name||'Product'}</div>
        </div>
        ${statusBadge(status)}
      </div>
      ${timeline}
      <div class="order-meta">
        <div class="order-row"><span class="order-row-label">Amount</span><span class="text-gold">${fmtCur(o.total_amount)}</span></div>
        <div class="order-row"><span class="order-row-label">Payment</span>${payBadge(o.payment_type)}</div>
        <div class="order-row"><span class="order-row-label">Deliver to</span><span class="text-sm">${o.drop_address||'â€”'}</span></div>
        <div class="order-row"><span class="order-row-label">Date</span><span class="text-sm text-muted">${fmtDate(o.created_at)}</span></div>
      </div>
      ${status==='delivered' ? `<div class="order-actions"><button class="btn btn-danger btn-sm" onclick="returnOrder('${o.id}')">â†©ï¸ Request Return</button></div>` : ''}
    </div>`;
  }).join('');
}

async function returnOrder(id) {
  if (!confirmAction('Request a return? Admin will review and contact you.')) return;
  await window.sb.from('orders').update({order_status:'returned'}).eq('id',id).eq('buyer_id',USER.id);
  await window.sb.from('payments').update({status:'returned'}).eq('order_id',id);
  toast('Return requested. Admin will review. âœ…', 'success');
  loadOrders();
}

/* â”€â”€ PROFILE â”€â”€ */
function loadProfile() {
  document.getElementById('p-name').value  = USER.name||'';
  document.getElementById('p-phone').value = USER.phone||'';
  document.getElementById('p-email').value = USER.email||'';
  document.getElementById('p-addr').value  = USER.address||'';
  document.getElementById('prof-name').textContent = USER.name||'â€”';
  document.getElementById('prof-av-wrap').innerHTML = renderUploadableAvatar(USER,'av-xl');
}

function onAvatarChange(e) {
  const file = e.target.files[0]; if (!file) return;
  const container = document.getElementById('prof-av-wrap').querySelector('.avatar');
  handleAvatarUpload(file, container, USER.id, url => {
    USER.avatar_url = url;
    renderUser();
  });
}

async function saveProfile() {
  const name  = document.getElementById('p-name').value.trim();
  const phone = document.getElementById('p-phone').value.trim();
  const addr  = document.getElementById('p-addr').value.trim();
  if (!name) { toast('Name is required', 'error'); return; }
  btnLoad('save-btn', true, 'â³ Savingâ€¦');
  const { error } = await window.sb.from('users').update({ name, phone:phone||null, address:addr||null }).eq('id',USER.id);
  if (error) { toast(error.message, 'error'); }
  else {
    USER = {...USER, name, phone, address:addr};
    document.getElementById('prof-name').textContent = name;
    renderUser(); toast('Profile saved âœ…', 'success');
  }
  btnLoad('save-btn', false);
}

async function resetPass() {
  const { error } = await window.sb.auth.resetPasswordForEmail(USER.email);
  if (error) toast(error.message, 'error');
  else toast('Password reset email sent âœ…', 'success');
}

/* â”€â”€ Helpers â”€â”€ */
function closeModal(id) { document.getElementById(id)?.classList.add('hidden'); }
function sleep(ms)      { return new Promise(r=>setTimeout(r,ms)); }
function hideSplash()   { const s=document.getElementById('loading-screen'); s.style.opacity='0'; setTimeout(()=>s.style.display='none',500); }
</script>
</body>
</html>
