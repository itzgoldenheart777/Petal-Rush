<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Petal Rush â€” Seller</title>
<link rel="stylesheet" href="../assets/css/styles.css">
<style>
.panel { display:none; } .panel.active { display:block; }
</style>
</head>
<body>
<div id="loading-screen"><div class="ls-logo">Petal Rush</div><div class="ls-sub">Seller Dashboard</div><div class="ls-bar"></div></div>
<div id="toast-root"></div>

<div class="dash-wrap hidden" id="app">
  <div class="sidebar-overlay" id="sb-overlay" onclick="closeSidebar()"></div>

  <nav class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <h1>Petal Rush</h1>
      <div class="sidebar-role">ğŸª Seller</div>
    </div>
    <div class="sidebar-user" onclick="navTo('profile')">
      <div id="sb-av"></div>
      <div class="sidebar-user-info">
        <div class="sidebar-user-name" id="sb-name">Loadingâ€¦</div>
        <div class="sidebar-user-email" id="sb-shop">â€”</div>
      </div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">Store</div>
      <button class="nav-item active" data-panel="overview" onclick="navTo('overview')"><span class="nav-icon">ğŸ“Š</span>Dashboard</button>
      <button class="nav-item" data-panel="products" onclick="navTo('products')"><span class="nav-icon">ğŸŒº</span>My Products</button>
      <button class="nav-item" data-panel="orders" onclick="navTo('orders')"><span class="nav-icon">ğŸ“¦</span>Orders</button>
      <button class="nav-item" data-panel="payments" onclick="navTo('payments')"><span class="nav-icon">ğŸ’°</span>Payments</button>
      <div class="nav-section">Account</div>
      <button class="nav-item" data-panel="profile" onclick="navTo('profile')"><span class="nav-icon">ğŸ‘¤</span>My Profile</button>
    </nav>
    <div class="sidebar-footer">
      <button class="nav-item" style="color:var(--rose-light)" onclick="logout()"><span class="nav-icon">ğŸšª</span>Sign Out</button>
    </div>
  </nav>

  <div class="topbar">
    <div class="topbar-left"><button class="menu-btn" onclick="toggleSidebar()">â˜°</button><div class="topbar-brand">Seller Panel</div></div>
    <div class="topbar-right">
      <button class="theme-toggle" onclick="toggleTheme()">â˜€ï¸</button>
      <div id="top-av" onclick="navTo('profile')" style="cursor:pointer"></div>
    </div>
  </div>

  <main class="main-content">

    <!-- OVERVIEW -->
    <div class="panel active" id="panel-overview">
      <div class="page-header"><div class="page-header-left"><h2>My <em>Dashboard</em></h2><div class="page-sub">Your store at a glance</div></div></div>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon">ğŸŒº</div><div class="stat-value" id="st-prods">â€”</div><div class="stat-label">Products</div></div>
        <div class="stat-card"><div class="stat-icon">ğŸ›’</div><div class="stat-value" id="st-orders">â€”</div><div class="stat-label">Total Orders</div></div>
        <div class="stat-card"><div class="stat-icon">ğŸ’°</div><div class="stat-value" id="st-rev">â€”</div><div class="stat-label">Revenue</div></div>
        <div class="stat-card"><div class="stat-icon">â³</div><div class="stat-value" id="st-pend">â€”</div><div class="stat-label">Pending</div></div>
      </div>
      <div class="grid-2">
        <div>
          <div class="section-header"><h3>Recent Orders</h3><button class="btn btn-ghost btn-sm" onclick="navTo('orders')">All â†’</button></div>
          <div id="ov-orders"><div class="empty-state"><div class="empty-icon">â³</div></div></div>
        </div>
        <div>
          <div class="section-header"><h3>My Products</h3><button class="btn btn-ghost btn-sm" onclick="navTo('products')">All â†’</button></div>
          <div id="ov-prods"><div class="empty-state"><div class="empty-icon">â³</div></div></div>
        </div>
      </div>
    </div>

    <!-- PRODUCTS -->
    <div class="panel" id="panel-products">
      <div class="page-header">
        <div class="page-header-left"><h2>My <em>Products</em></h2></div>
        <div class="page-actions"><button class="btn btn-primary" onclick="openProdForm()">+ Add Product</button></div>
      </div>
      <div class="products-grid" id="prods-grid"><div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">â³</div><h3>Loadingâ€¦</h3></div></div>
    </div>

    <!-- ORDERS -->
    <div class="panel" id="panel-orders">
      <div class="page-header"><div class="page-header-left"><h2>My <em>Orders</em></h2></div></div>
      <div class="table-wrap">
        <table><thead><tr><th>Order</th><th>Product</th><th>Amount</th><th>Payment</th><th>Status</th><th>Date</th></tr></thead>
        <tbody id="orders-tb"></tbody></table>
      </div>
    </div>

    <!-- PAYMENTS -->
    <div class="panel" id="panel-payments">
      <div class="page-header"><div class="page-header-left"><h2>My <em>Payments</em></h2></div></div>
      <div class="stats-grid mb-2">
        <div class="stat-card"><div class="stat-icon">âœ…</div><div class="stat-value" id="pay-rel">â‚¹0</div><div class="stat-label">Released</div></div>
        <div class="stat-card"><div class="stat-icon">â³</div><div class="stat-value" id="pay-pend">â‚¹0</div><div class="stat-label">Pending</div></div>
        <div class="stat-card"><div class="stat-icon">â†©ï¸</div><div class="stat-value" id="pay-ret">â‚¹0</div><div class="stat-label">Returned</div></div>
      </div>
      <div class="table-wrap">
        <table><thead><tr><th>Order ID</th><th>Amount</th><th>Method</th><th>Status</th><th>Date</th></tr></thead>
        <tbody id="pay-tb"></tbody></table>
      </div>
    </div>

    <!-- PROFILE -->
    <div class="panel" id="panel-profile">
      <div class="page-header"><div class="page-header-left"><h2>My <em>Profile</em></h2></div></div>
      <div class="profile-wrap">
        <div class="profile-card mb-2">
          <div class="profile-cover"><div class="profile-cover-av" id="prof-av-wrap"></div></div>
          <div class="profile-info">
            <div class="profile-name" id="prof-name">â€”</div>
            <div class="profile-role-badge">ğŸª Seller</div>
            <p class="profile-hint">Tap your photo to upload a new avatar</p>
          </div>
        </div>
        <div class="card mb-2">
          <div class="card-header"><h3>Personal Information</h3></div>
          <div class="flex flex-col gap-2">
            <div class="form-row">
              <div class="form-group"><label>Full Name</label><input type="text" id="p-name" /></div>
              <div class="form-group"><label>Shop Name</label><input type="text" id="p-shop" /></div>
            </div>
            <div class="form-row">
              <div class="form-group"><label>Phone</label><input type="tel" id="p-phone" /></div>
              <div class="form-group"><label>Email</label><input type="email" id="p-email" disabled /></div>
            </div>
            <div class="form-group">
              <label>Shop / Pickup Address</label>
              <div class="flex gap-1">
                <input type="text" id="p-addr" style="flex:1" />
                <button class="btn btn-secondary btn-sm" id="p-gps" onclick="detectGPS('p-addr','p-gps')" style="flex-shrink:0">ğŸ“</button>
              </div>
            </div>
            <button class="btn btn-primary" id="save-btn" onclick="saveProfile()">Save Changes</button>
          </div>
        </div>
        <div class="card"><div class="card-header"><h3>Security</h3></div>
          <button class="btn btn-secondary btn-full" onclick="resetPass()">ğŸ”‘ Change Password</button>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- Product Form Modal -->
<div class="modal-overlay hidden" id="prod-modal">
  <div class="modal">
    <div class="modal-header"><h3 id="pf-title">Add Product</h3><button class="modal-close" onclick="closeProdModal()">âœ•</button></div>
    <div class="modal-body">
      <input type="hidden" id="pf-id" />
      <div class="flex flex-col gap-2">
        <div class="form-row">
          <div class="form-group"><label>Name *</label><input type="text" id="pf-name" placeholder="Red Rose Bouquet" /></div>
          <div class="form-group"><label>Category</label>
            <select id="pf-cat"><option value="flowers">ğŸŒ¸ Flowers</option><option value="bouquets">ğŸ’ Bouquets</option><option value="plants">ğŸª´ Plants</option><option value="gifts">ğŸ Gifts</option></select>
          </div>
        </div>
        <div class="form-group"><label>Description</label><textarea id="pf-desc" placeholder="Fresh hand-pickedâ€¦"></textarea></div>
        <div class="form-row">
          <div class="form-group"><label>Price â‚¹ *</label><input type="number" id="pf-price" placeholder="499" min="1" /></div>
          <div class="form-group"><label>Quantity *</label><input type="number" id="pf-qty" placeholder="20" min="0" /></div>
        </div>
        <div class="form-group"><label>Image URL (optional)</label><input type="url" id="pf-img" placeholder="https://â€¦" /></div>
        <div class="form-group" id="pf-img-preview-wrap" style="display:none">
          <label>Preview</label>
          <img id="pf-img-preview" style="width:100%;height:120px;object-fit:cover;border-radius:8px;border:1px solid var(--border)" />
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeProdModal()">Cancel</button>
      <button class="btn btn-primary" id="pf-save" onclick="saveProd()">Save Product</button>
    </div>
  </div>
</div>

<script src="../assets/js/config.js"></script>
<script src="../assets/js/auth.js"></script>
<script src="../assets/js/utils.js"></script>
<script>
let USER = null, MY_PRODS = [];

window.addEventListener('load', async () => {
  applyTheme(localStorage.getItem(PR_THEME_KEY)||'dark');
  await sleep(1500); hideSplash();
  USER = await requireRole('seller');
  if (!USER) return;
  // Load shop name from sellers table
  const { data: seller } = await window.sb.from('sellers').select('shop_name').eq('user_id',USER.id).single();
  USER.shop_name = seller?.shop_name || '';
  renderUser();
  document.getElementById('app').classList.remove('hidden');
  navTo('overview');
});

function renderUser() {
  document.getElementById('sb-name').textContent = USER.name;
  document.getElementById('sb-shop').textContent = USER.shop_name || USER.email;
  document.getElementById('sb-av').innerHTML   = renderAvatar(USER,'av-md');
  document.getElementById('top-av').innerHTML  = renderAvatar(USER,'av-sm');
}

window.showPanel = navTo;
function navTo(id) {
  ['overview','products','orders','payments','profile'].forEach(p => {
    document.getElementById(`panel-${p}`)?.style && (document.getElementById(`panel-${p}`).style.display = p===id?'':'none');
  });
  setActiveNav(id);
  closeSidebar();
  if (id==='overview') loadOverview();
  if (id==='products') loadProducts();
  if (id==='orders')   loadOrders();
  if (id==='payments') loadPayments();
  if (id==='profile')  loadProfile();
}

/* â”€â”€ OVERVIEW â”€â”€ */
async function loadOverview() {
  const [{ data: prods }, { data: orders }] = await Promise.all([
    window.sb.from('products').select('*').eq('seller_id',USER.id).eq('is_active',true),
    window.sb.from('orders').select('*').eq('seller_id',USER.id).order('created_at',{ascending:false})
  ]);
  MY_PRODS = prods||[];
  const rev  = (orders||[]).reduce((s,o)=>s+Number(o.total_amount||0),0);
  const pend = (orders||[]).filter(o=>o.order_status==='placed').length;
  document.getElementById('st-prods').textContent  = MY_PRODS.length;
  document.getElementById('st-orders').textContent = (orders||[]).length;
  document.getElementById('st-rev').textContent    = fmtCur(rev);
  document.getElementById('st-pend').textContent   = pend;

  const oel = document.getElementById('ov-orders');
  oel.innerHTML = (orders||[]).slice(0,4).map(o=>`
    <div class="order-card">
      <div class="order-header">
        <div><div class="order-id">${shortId(o.id)}</div></div>
        ${statusBadge(o.order_status)}
      </div>
      <div class="order-row"><span class="order-row-label">Amount</span><span class="text-gold">${fmtCur(o.total_amount)}</span></div>
    </div>`).join('')||`<div class="empty-state"><div class="empty-icon">ğŸ“¦</div><h3>No orders yet</h3></div>`;

  const pel = document.getElementById('ov-prods');
  pel.innerHTML = MY_PRODS.slice(0,4).map(p=>`
    <div class="card mb-1">
      <div class="flex justify-between items-center">
        <span style="font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--cream)">${p.name}</span>
        <span class="text-gold">${fmtCur(p.price)}</span>
      </div>
      <div class="text-muted text-xs mt-1">${p.quantity} in stock Â· ${p.category}</div>
    </div>`).join('')||`<div class="empty-state"><div class="empty-icon">ğŸŒ¸</div><h3>No products yet</h3></div>`;
}

/* â”€â”€ PRODUCTS â”€â”€ */
async function loadProducts() {
  const { data, error } = await window.sb.from('products').select('*').eq('seller_id',USER.id).order('created_at',{ascending:false});
  MY_PRODS = data||[];
  const grid = document.getElementById('prods-grid');
  if (error) { grid.innerHTML=`<div class="alert alert-error">${error.message}</div>`; return; }
  if (!MY_PRODS.length) {
    grid.innerHTML=`<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">ğŸŒ¸</div><h3>No products yet</h3><p>Add your first product to start selling.</p><button class="btn btn-primary mt-2" onclick="openProdForm()">+ Add First Product</button></div>`;
    return;
  }
  grid.innerHTML = MY_PRODS.map(p=>`
    <div class="product-card" style="${!p.is_active?'opacity:0.55':''}">
      <div class="product-img">
        ${p.image_url?`<img src="${p.image_url}" alt="${p.name}" loading="lazy" onerror="this.parentElement.innerHTML='${prodEmoji(p.category)}'" />`:''}
        ${!p.image_url?prodEmoji(p.category):''}
        <span class="product-cat">${p.category}</span>
        ${!p.is_active?`<div style="position:absolute;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;color:#fff;font-size:13px;font-weight:600">Inactive</div>`:''}
      </div>
      <div class="product-body">
        <div class="product-name">${p.name}</div>
        <div class="product-desc">${p.description||'â€”'}</div>
        <div class="product-footer">
          <div><div class="product-price">â‚¹${Number(p.price).toLocaleString('en-IN')}</div><div class="product-qty">${p.quantity} left</div></div>
        </div>
      </div>
      <div class="product-actions">
        <button class="btn btn-secondary btn-sm" style="flex:1" onclick="openProdForm('${p.id}')">âœï¸ Edit</button>
        <button class="btn btn-danger btn-sm" style="flex:1" onclick="delProd('${p.id}')">${p.is_active?'ğŸ—‘ï¸ Delete':'â™»ï¸ Restore'}</button>
      </div>
    </div>`).join('');
}

function openProdForm(id) {
  document.getElementById('pf-id').value = id||'';
  if (id) {
    const p = MY_PRODS.find(x=>x.id===id); if (!p) return;
    document.getElementById('pf-title').textContent = 'Edit Product';
    document.getElementById('pf-name').value  = p.name;
    document.getElementById('pf-desc').value  = p.description||'';
    document.getElementById('pf-price').value = p.price;
    document.getElementById('pf-qty').value   = p.quantity;
    document.getElementById('pf-img').value   = p.image_url||'';
    document.getElementById('pf-cat').value   = p.category||'flowers';
    showImgPreview(p.image_url);
  } else {
    document.getElementById('pf-title').textContent = 'Add New Product';
    ['pf-name','pf-desc','pf-price','pf-qty','pf-img'].forEach(i=>document.getElementById(i).value='');
    document.getElementById('pf-img-preview-wrap').style.display='none';
  }
  document.getElementById('prod-modal').classList.remove('hidden');
}
function closeProdModal() { document.getElementById('prod-modal').classList.add('hidden'); }

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('pf-img')?.addEventListener('input', function() { showImgPreview(this.value); });
});
function showImgPreview(url) {
  const wrap = document.getElementById('pf-img-preview-wrap');
  const img  = document.getElementById('pf-img-preview');
  if (url) { img.src = url; wrap.style.display=''; }
  else wrap.style.display='none';
}

async function saveProd() {
  const name  = document.getElementById('pf-name').value.trim();
  const price = parseFloat(document.getElementById('pf-price').value);
  const qty   = parseInt(document.getElementById('pf-qty').value)||0;
  const desc  = document.getElementById('pf-desc').value.trim();
  const img   = document.getElementById('pf-img').value.trim();
  const cat   = document.getElementById('pf-cat').value;
  const id    = document.getElementById('pf-id').value;
  if (!name || !price) { toast('Name and price are required', 'error'); return; }
  btnLoad('pf-save', true, 'â³ Savingâ€¦');
  const row = { name, price, quantity:qty, description:desc||null, image_url:img||null, category:cat };
  try {
    if (id) {
      const { error } = await window.sb.from('products').update(row).eq('id',id).eq('seller_id',USER.id);
      if (error) throw error;
      toast('Product updated âœ…', 'success');
    } else {
      const { error } = await window.sb.from('products').insert({...row, seller_id:USER.id});
      if (error) throw error;
      toast('Product added âœ…', 'success');
    }
    closeProdModal(); loadProducts();
  } catch(e) { toast(e.message, 'error'); }
  finally { btnLoad('pf-save', false); }
}

async function delProd(id) {
  const p = MY_PRODS.find(x=>x.id===id);
  const action = p?.is_active ? 'delete (deactivate)' : 'restore';
  if (!confirmAction(`Are you sure you want to ${action} this product?`)) return;
  const { error } = await window.sb.from('products').update({ is_active: !p?.is_active }).eq('id',id).eq('seller_id',USER.id);
  if (error) { toast(error.message,'error'); return; }
  toast(`Product ${p?.is_active?'deleted':'restored'} âœ…`, 'success');
  loadProducts();
}

/* â”€â”€ ORDERS â”€â”€ */
async function loadOrders() {
  const { data, error } = await window.sb.from('orders').select('*, products(name)').eq('seller_id',USER.id).order('created_at',{ascending:false});
  const tbody = document.getElementById('orders-tb');
  if (error) { tbody.innerHTML=`<tr><td colspan="6" class="text-center text-muted" style="padding:32px">${error.message}</td></tr>`; return; }
  tbody.innerHTML = (data||[]).length
    ? (data||[]).map(o=>`<tr>
        <td><code>${shortId(o.id)}</code></td>
        <td>${o.products?.name||'â€”'}</td>
        <td class="text-gold">${fmtCur(o.total_amount)}</td>
        <td>${payBadge(o.payment_type)}</td>
        <td>${statusBadge(o.order_status)}</td>
        <td class="text-muted">${fmtDate(o.created_at)}</td>
      </tr>`).join('')
    : `<tr><td colspan="6" class="text-center text-muted" style="padding:32px">No orders yet</td></tr>`;
}

/* â”€â”€ PAYMENTS â”€â”€ */
async function loadPayments() {
  const { data, error } = await window.sb.from('payments').select('*').eq('seller_id',USER.id).order('created_at',{ascending:false});
  const payments = data||[];
  const rel  = payments.filter(p=>p.status==='released').reduce((s,p)=>s+Number(p.amount||0),0);
  const pend = payments.filter(p=>['pending','admin_wallet'].includes(p.status)).reduce((s,p)=>s+Number(p.amount||0),0);
  const ret  = payments.filter(p=>p.status==='returned').reduce((s,p)=>s+Number(p.amount||0),0);
  document.getElementById('pay-rel').textContent  = fmtCur(rel);
  document.getElementById('pay-pend').textContent = fmtCur(pend);
  document.getElementById('pay-ret').textContent  = fmtCur(ret);
  const tbody = document.getElementById('pay-tb');
  tbody.innerHTML = payments.length
    ? payments.map(p=>`<tr>
        <td><code>${shortId(p.order_id||p.id)}</code></td>
        <td class="text-gold">${fmtCur(p.amount)}</td>
        <td>${payBadge(p.payment_method)}</td>
        <td>${statusBadge(p.status)}</td>
        <td class="text-muted">${fmtDate(p.created_at)}</td>
      </tr>`).join('')
    : `<tr><td colspan="5" class="text-center text-muted" style="padding:32px">No payments yet</td></tr>`;
}

/* â”€â”€ PROFILE â”€â”€ */
function loadProfile() {
  document.getElementById('p-name').value  = USER.name||'';
  document.getElementById('p-phone').value = USER.phone||'';
  document.getElementById('p-email').value = USER.email||'';
  document.getElementById('p-addr').value  = USER.address||'';
  document.getElementById('p-shop').value  = USER.shop_name||'';
  document.getElementById('prof-name').textContent = USER.name||'â€”';
  document.getElementById('prof-av-wrap').innerHTML = renderUploadableAvatar(USER,'av-xl');
}
function onAvatarChange(e) {
  const file=e.target.files[0]; if(!file)return;
  const container = document.getElementById('prof-av-wrap').querySelector('.avatar');
  handleAvatarUpload(file, container, USER.id, url=>{
    USER.avatar_url=url; renderUser();
  });
}
async function saveProfile() {
  const name=document.getElementById('p-name').value.trim();
  const phone=document.getElementById('p-phone').value.trim();
  const addr=document.getElementById('p-addr').value.trim();
  const shop=document.getElementById('p-shop').value.trim();
  if(!name){toast('Name is required','error');return;}
  btnLoad('save-btn',true,'â³ Savingâ€¦');
  try {
    const {error}=await window.sb.from('users').update({name,phone:phone||null,address:addr||null}).eq('id',USER.id);
    if(error)throw error;
    if(shop) await window.sb.from('sellers').update({shop_name:shop}).eq('user_id',USER.id);
    USER={...USER,name,phone,address:addr,shop_name:shop};
    document.getElementById('prof-name').textContent=name;
    document.getElementById('sb-shop').textContent=shop||USER.email;
    renderUser(); toast('Profile saved âœ…','success');
  }catch(e){toast(e.message,'error');}
  finally{btnLoad('save-btn',false);}
}
async function resetPass() {
  const{error}=await window.sb.auth.resetPasswordForEmail(USER.email);
  if(error)toast(error.message,'error');
  else toast('Password reset email sent âœ…','success');
}

/* â”€â”€ Helpers â”€â”€ */
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
function hideSplash(){const s=document.getElementById('loading-screen');s.style.opacity='0';setTimeout(()=>s.style.display='none',500);}
</script>
</body>
</html>
