<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Petal Rush â€” Admin</title>
<link rel="stylesheet" href="../assets/css/styles.css">
<style>
.panel{display:none;}.panel.active{display:block;}
.admin-role { background:rgba(196,83,90,0.12)!important; border-color:rgba(196,83,90,0.28)!important; color:var(--rose-light)!important; }
/* Config settings styles */
.settings-section { background:var(--surface); border:1px solid var(--border); border-radius:var(--r); padding:20px; margin-bottom:16px; transition:background 0.25s,border-color 0.25s; }
.settings-section h3 { font-size:15px; font-weight:600; margin-bottom:4px; color:var(--text); }
.settings-section p  { font-size:12px; color:var(--text-muted); margin-bottom:14px; line-height:1.55; }
.conn-indicator { display:inline-flex; align-items:center; gap:7px; padding:7px 12px; border-radius:8px; font-size:12px; margin-bottom:12px; }
.conn-indicator.ok  { background:rgba(62,122,85,0.1);  border:1px solid rgba(62,122,85,0.25);  color:var(--green-light); }
.conn-indicator.bad { background:rgba(196,83,90,0.1); border:1px solid rgba(196,83,90,0.25); color:var(--rose-light); }
.conn-dot { width:8px; height:8px; border-radius:50%; background:currentColor; flex-shrink:0; }
</style>
</head>
<body>
<div id="loading-screen"><div class="ls-logo">Petal Rush</div><div class="ls-sub">Admin Panel</div><div class="ls-bar"></div></div>
<div id="toast-root"></div>

<div class="dash-wrap hidden" id="app">
  <div class="sidebar-overlay" id="sb-overlay" onclick="closeSidebar()"></div>

  <nav class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <h1>Petal Rush</h1>
      <div class="sidebar-role admin-role">ğŸ› ï¸ Admin</div>
    </div>
    <div class="sidebar-user" onclick="navTo('profile')">
      <div id="sb-av"></div>
      <div class="sidebar-user-info">
        <div class="sidebar-user-name" id="sb-name">Admin</div>
        <div class="sidebar-user-email" id="sb-email">â€¦</div>
      </div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">Management</div>
      <button class="nav-item active" data-panel="overview"   onclick="navTo('overview')"><span class="nav-icon">ğŸ“Š</span>Overview</button>
      <button class="nav-item" data-panel="orders"     onclick="navTo('orders')"><span class="nav-icon">ğŸ“¦</span>All Orders<span class="nav-badge hidden" id="ord-badge">!</span></button>
      <button class="nav-item" data-panel="users"      onclick="navTo('users')"><span class="nav-icon">ğŸ‘¥</span>Users</button>
      <button class="nav-item" data-panel="deliveries" onclick="navTo('deliveries')"><span class="nav-icon">ğŸšš</span>Assign Delivery</button>
      <button class="nav-item" data-panel="payments"   onclick="navTo('payments')"><span class="nav-icon">ğŸ’°</span>Payments</button>
      <button class="nav-item" data-panel="products"   onclick="navTo('products')"><span class="nav-icon">ğŸŒº</span>Products</button>
      <div class="nav-section">Account</div>
      <button class="nav-item" data-panel="profile"    onclick="navTo('profile')"><span class="nav-icon">ğŸ‘¤</span>My Profile</button>
      <button class="nav-item" data-panel="settings"   onclick="navTo('settings')"><span class="nav-icon">âš™ï¸</span>Settings</button>
    </nav>
    <div class="sidebar-footer">
      <button class="nav-item" style="color:var(--rose-light)" onclick="logout()"><span class="nav-icon">ğŸšª</span>Sign Out</button>
    </div>
  </nav>

  <div class="topbar">
    <div class="topbar-left"><button class="menu-btn" onclick="toggleSidebar()">â˜°</button><div class="topbar-brand">Admin Panel</div></div>
    <div class="topbar-right">
      <button class="theme-toggle" onclick="toggleTheme()">â˜€ï¸</button>
      <div id="top-av" onclick="navTo('profile')" style="cursor:pointer"></div>
    </div>
  </div>

  <main class="main-content">

    <!-- OVERVIEW -->
    <div class="panel active" id="panel-overview">
      <div class="page-header"><div class="page-header-left"><h2>Platform <em>Overview</em></h2><div class="page-sub">Your marketplace at a glance</div></div></div>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon">ğŸ‘¥</div><div class="stat-value" id="st-users">â€”</div><div class="stat-label">Total Users</div></div>
        <div class="stat-card"><div class="stat-icon">ğŸ“¦</div><div class="stat-value" id="st-orders">â€”</div><div class="stat-label">All Orders</div></div>
        <div class="stat-card"><div class="stat-icon">ğŸ’°</div><div class="stat-value" id="st-rev">â€”</div><div class="stat-label">Revenue</div></div>
        <div class="stat-card"><div class="stat-icon">ğŸª</div><div class="stat-value" id="st-sellers">â€”</div><div class="stat-label">Sellers</div></div>
        <div class="stat-card"><div class="stat-icon">â³</div><div class="stat-value" id="st-pend">â€”</div><div class="stat-label">Pending</div></div>
        <div class="stat-card"><div class="stat-icon">ğŸ¦</div><div class="stat-value" id="st-wallet">â€”</div><div class="stat-label">Admin Wallet</div></div>
      </div>
      <div class="grid-2">
        <div>
          <div class="section-header"><h3>Recent Orders</h3><button class="btn btn-ghost btn-sm" onclick="navTo('orders')">All â†’</button></div>
          <div id="ov-orders"></div>
        </div>
        <div>
          <div class="section-header"><h3>Quick Actions</h3></div>
          <div id="ov-actions"></div>
        </div>
      </div>
    </div>

    <!-- ORDERS -->
    <div class="panel" id="panel-orders">
      <div class="page-header">
        <div class="page-header-left"><h2>All <em>Orders</em></h2></div>
        <div class="page-actions">
          <select id="ord-status" onchange="loadOrders()" style="width:150px">
            <option value="">All Statuses</option>
            <option value="placed">Placed</option>
            <option value="assigned">Assigned</option>
            <option value="picked">Picked</option>
            <option value="delivered">Delivered</option>
            <option value="returned">Returned</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
      </div>
      <div class="table-wrap">
        <table><thead><tr><th>Order ID</th><th>Amount</th><th>Payment</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead>
        <tbody id="orders-tb"></tbody></table>
      </div>
    </div>

    <!-- USERS -->
    <div class="panel" id="panel-users">
      <div class="page-header">
        <div class="page-header-left"><h2>Manage <em>Users</em></h2></div>
        <div class="page-actions">
          <select id="role-filter" onchange="loadUsers()" style="width:140px">
            <option value="">All Roles</option>
            <option value="buyer">Buyers</option>
            <option value="seller">Sellers</option>
            <option value="delivery">Delivery</option>
          </select>
        </div>
      </div>
      <div class="table-wrap">
        <table><thead><tr><th>User</th><th>Email</th><th>Role</th><th>Phone</th><th>Status</th><th>Joined</th><th>Actions</th></tr></thead>
        <tbody id="users-tb"></tbody></table>
      </div>
    </div>

    <!-- DELIVERIES -->
    <div class="panel" id="panel-deliveries">
      <div class="page-header"><div class="page-header-left"><h2>Assign <em>Deliveries</em></h2><div class="page-sub">Unassigned orders waiting for a delivery partner</div></div></div>
      <div id="del-list"><div class="empty-state"><div class="empty-icon">â³</div><h3>Loadingâ€¦</h3></div></div>
    </div>

    <!-- PAYMENTS -->
    <div class="panel" id="panel-payments">
      <div class="page-header"><div class="page-header-left"><h2>Payment <em>Control</em></h2></div></div>
      <div class="stats-grid mb-2">
        <div class="stat-card"><div class="stat-icon">ğŸ¦</div><div class="stat-value" id="pay-wallet">â‚¹0</div><div class="stat-label">Admin Wallet</div></div>
        <div class="stat-card"><div class="stat-icon">âœ…</div><div class="stat-value" id="pay-rel">â‚¹0</div><div class="stat-label">Released</div></div>
        <div class="stat-card"><div class="stat-icon">â¸</div><div class="stat-value" id="pay-held">â‚¹0</div><div class="stat-label">Held</div></div>
      </div>
      <div class="table-wrap">
        <table><thead><tr><th>Order</th><th>Amount</th><th>Method</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead>
        <tbody id="pay-tb"></tbody></table>
      </div>
    </div>

    <!-- PRODUCTS -->
    <div class="panel" id="panel-products">
      <div class="page-header"><div class="page-header-left"><h2>All <em>Products</em></h2></div>
        <div class="page-actions">
          <select id="prod-status" onchange="loadProducts()" style="width:140px">
            <option value="true">Active Only</option>
            <option value="">All</option>
            <option value="false">Inactive</option>
          </select>
        </div>
      </div>
      <div class="products-grid" id="prods-grid"><div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">â³</div></div></div>
    </div>

    <!-- PROFILE -->
    <div class="panel" id="panel-profile">
      <div class="page-header"><div class="page-header-left"><h2>Admin <em>Profile</em></h2></div></div>
      <div class="profile-wrap">
        <div class="profile-card mb-2">
          <div class="profile-cover" style="background:linear-gradient(135deg,rgba(196,83,90,0.15) 0%,var(--bg3) 100%)">
            <div class="profile-cover-av" id="prof-av-wrap"></div>
          </div>
          <div class="profile-info">
            <div class="profile-name" id="prof-name">Admin</div>
            <div class="profile-role-badge admin-role">ğŸ› ï¸ Administrator</div>
            <p class="profile-hint">Tap photo to upload a new avatar</p>
          </div>
        </div>
        <div class="card mb-2">
          <div class="card-header"><h3>Account Information</h3></div>
          <div class="flex flex-col gap-2">
            <div class="form-row">
              <div class="form-group"><label>Full Name</label><input type="text" id="p-name" /></div>
              <div class="form-group"><label>Phone</label><input type="tel" id="p-phone" /></div>
            </div>
            <div class="form-group"><label>Email</label><input type="email" id="p-email" disabled /></div>
            <button class="btn btn-primary" id="save-btn" onclick="saveProfile()">Save Changes</button>
          </div>
        </div>
        <div class="card"><div class="card-header"><h3>Security</h3></div>
          <button class="btn btn-secondary btn-full" onclick="resetPass()">ğŸ”‘ Change Password</button>
        </div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div class="panel" id="panel-settings">
      <div class="page-header"><div class="page-header-left"><h2>App <em>Settings</em></h2><div class="page-sub">Configure your Petal Rush instance</div></div></div>

      <!-- Supabase Config -->
      <div class="settings-section">
        <h3>ğŸ”Œ Supabase Configuration</h3>
        <p>Update your Supabase project URL and API key. Changes take effect immediately for all users.</p>
        <div id="sb-conn-indicator" class="conn-indicator ok"><div class="conn-dot"></div><span id="sb-conn-text">Connected</span></div>
        <div class="flex flex-col gap-2">
          <div class="form-group">
            <label>Project URL</label>
            <input type="url" id="cfg-url" placeholder="https://xxxx.supabase.co" spellcheck="false" />
          </div>
          <div class="form-group">
            <label>Anon / Public Key</label>
            <input type="text" id="cfg-key" placeholder="eyJhbGciâ€¦" spellcheck="false" />
          </div>
        </div>
        <div class="flex gap-1 mt-2">
          <button class="btn btn-primary" id="cfg-save-btn" onclick="saveDBConfig()">Save & Reconnect</button>
          <button class="btn btn-secondary" onclick="testDBConn()">Test Connection</button>
        </div>
        <div class="alert alert-info mt-2" style="font-size:12px">
          <strong>âš ï¸ Note:</strong> Changing the database URL/key will update credentials stored in this browser. All users on other devices will need to update their credentials from the login page.
        </div>
      </div>

      <!-- Theme -->
      <div class="settings-section">
        <h3>ğŸ¨ Appearance</h3>
        <p>Switch between light and dark mode.</p>
        <div class="flex gap-1">
          <button class="btn btn-secondary" id="theme-dark-btn" onclick="setTheme('dark')">ğŸŒ™ Dark Mode</button>
          <button class="btn btn-secondary" id="theme-light-btn" onclick="setTheme('light')">â˜€ï¸ Light Mode</button>
        </div>
      </div>

      <!-- Info -->
      <div class="settings-section">
        <h3>â„¹ï¸ System Information</h3>
        <p>Platform details and version info.</p>
        <div class="flex flex-col gap-1 text-sm text-muted">
          <div>Platform: <strong style="color:var(--text)">Petal Rush v3.0</strong></div>
          <div>Database: <strong style="color:var(--text)" id="info-db">â€”</strong></div>
          <div>Admin: <strong style="color:var(--text)" id="info-admin">â€”</strong></div>
        </div>
      </div>

    </div>

  </main>
</div>

<!-- Assign Delivery Modal -->
<div class="modal-overlay hidden" id="assign-modal">
  <div class="modal">
    <div class="modal-header"><h3>Assign Delivery Partner</h3><button class="modal-close" onclick="closeModal('assign-modal')">âœ•</button></div>
    <div class="modal-body">
      <input type="hidden" id="asgn-order-id" />
      <p class="text-muted text-sm mb-2">Assign a delivery partner to order <strong id="asgn-order-ref" class="text-gold"></strong></p>
      <div class="form-group mb-1">
        <label>Pickup Address (Seller Location)</label>
        <div class="flex gap-1">
          <input type="text" id="asgn-pickup" placeholder="Seller's address" style="flex:1" />
          <button class="btn btn-secondary btn-sm" id="asgn-gps" onclick="detectGPS('asgn-pickup','asgn-gps')" style="flex-shrink:0">ğŸ“</button>
        </div>
      </div>
      <div class="form-group">
        <label>Delivery Partner</label>
        <select id="asgn-partner"><option value="">Loading partnersâ€¦</option></select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('assign-modal')">Cancel</button>
      <button class="btn btn-primary" id="asgn-confirm" onclick="confirmAssign()">Assign ğŸšš</button>
    </div>
  </div>
</div>

<script src="../assets/js/config.js"></script>
<script src="../assets/js/auth.js"></script>
<script src="../assets/js/utils.js"></script>
<script>
let USER = null, PARTNERS = [];

window.addEventListener('load', async () => {
  applyTheme(localStorage.getItem(PR_THEME_KEY)||'dark');
  await sleep(1500); hideSplash();
  USER = await requireRole('admin');
  if (!USER) return;
  document.getElementById('sb-name').textContent  = USER.name;
  document.getElementById('sb-email').textContent = USER.email;
  document.getElementById('sb-av').innerHTML   = renderAvatar(USER,'av-md');
  document.getElementById('top-av').innerHTML  = renderAvatar(USER,'av-sm');
  document.getElementById('app').classList.remove('hidden');
  navTo('overview');
});

window.showPanel = navTo;
function navTo(id) {
  ['overview','orders','users','deliveries','payments','products','profile','settings'].forEach(p=>{
    const el=document.getElementById(`panel-${p}`);
    if(el) el.style.display = p===id?'':'none';
  });
  setActiveNav(id);
  closeSidebar();
  if(id==='overview')   loadOverview();
  if(id==='orders')     loadOrders();
  if(id==='users')      loadUsers();
  if(id==='deliveries') loadDeliveries();
  if(id==='payments')   loadPayments();
  if(id==='products')   loadProducts();
  if(id==='profile')    loadProfile();
  if(id==='settings')   loadSettings();
}

/* â”€â”€ OVERVIEW â”€â”€ */
async function loadOverview() {
  const [{ data: users },{ data: orders },{ data: payments }] = await Promise.all([
    window.sb.from('users').select('id,role'),
    window.sb.from('orders').select('*').order('created_at',{ascending:false}),
    window.sb.from('payments').select('amount,status,order_id')
  ]);
  const sellers = (users||[]).filter(u=>u.role==='seller').length;
  const rev     = (orders||[]).reduce((s,o)=>s+Number(o.total_amount||0),0);
  const pend    = (orders||[]).filter(o=>o.order_status==='placed').length;
  const wallet  = (payments||[]).filter(p=>p.status==='admin_wallet').reduce((s,p)=>s+Number(p.amount||0),0);

  document.getElementById('st-users').textContent   = (users||[]).length;
  document.getElementById('st-orders').textContent  = (orders||[]).length;
  document.getElementById('st-rev').textContent     = fmtCur(rev);
  document.getElementById('st-sellers').textContent = sellers;
  document.getElementById('st-pend').textContent    = pend;
  document.getElementById('st-wallet').textContent  = fmtCur(wallet);

  if (pend>0) { const b=document.getElementById('ord-badge'); b.textContent=pend; b.classList.remove('hidden'); }

  document.getElementById('ov-orders').innerHTML = (orders||[]).slice(0,5).map(o=>`
    <div class="order-card">
      <div class="order-header"><div><div class="order-id">${shortId(o.id)}</div></div>${statusBadge(o.order_status)}</div>
      <div class="order-row"><span class="order-row-label">Amount</span><span class="text-gold">${fmtCur(o.total_amount)}</span></div>
      <div class="order-row"><span class="order-row-label">Payment</span>${payBadge(o.payment_type)}</div>
    </div>`).join('')||`<div class="empty-state"><div class="empty-icon">ğŸ“¦</div><h3>No orders</h3></div>`;

  const unassigned = (orders||[]).filter(o=>o.order_status==='placed');
  const toRelease  = (payments||[]).filter(p=>p.status==='admin_wallet');
  document.getElementById('ov-actions').innerHTML = [
    ...unassigned.slice(0,3).map(o=>`
      <div class="card mb-1"><div class="flex justify-between items-center">
        <div><div class="text-xs text-muted">Unassigned Order</div><div class="text-sm mt-1">${shortId(o.id)} â€” ${fmtCur(o.total_amount)}</div></div>
        <button class="btn btn-primary btn-xs" onclick="openAssign('${o.id}')">Assign ğŸšš</button>
      </div></div>`),
    ...toRelease.slice(0,3).map(p=>`
      <div class="card mb-1"><div class="flex justify-between items-center">
        <div><div class="text-xs text-muted">Ready to Release</div><div class="text-sm mt-1">${shortId(p.order_id||p.id)} â€” ${fmtCur(p.amount)}</div></div>
        <button class="btn btn-success btn-xs" onclick="relPayment('${p.id}')">Release ğŸ’°</button>
      </div></div>`)
  ].join('')||`<div class="empty-state"><div class="empty-icon">âœ…</div><h3>All caught up!</h3></div>`;
}

/* â”€â”€ ORDERS â”€â”€ */
async function loadOrders() {
  const sf = document.getElementById('ord-status')?.value;
  let q = window.sb.from('orders').select('*').order('created_at',{ascending:false});
  if (sf) q = q.eq('order_status',sf);
  const { data, error } = await q;
  const tbody = document.getElementById('orders-tb');
  if (error) { tbody.innerHTML=`<tr><td colspan="6" style="padding:24px;text-align:center;color:var(--rose-light)">${error.message}</td></tr>`; return; }
  tbody.innerHTML = (data||[]).length
    ? (data||[]).map(o=>`<tr>
        <td><code>${shortId(o.id)}</code></td>
        <td class="text-gold">${fmtCur(o.total_amount)}</td>
        <td>${payBadge(o.payment_type)}</td>
        <td>${statusBadge(o.order_status)}</td>
        <td class="text-muted">${fmtDate(o.created_at)}</td>
        <td><div class="td-actions">
          ${o.order_status==='placed'?`<button class="btn btn-primary btn-xs" onclick="openAssign('${o.id}')">ğŸšš Assign</button>`:''}
          ${o.order_status==='delivered'?`<button class="btn btn-success btn-xs" onclick="relByOrder('${o.id}')">ğŸ’° Release</button>`:''}
          ${o.order_status==='returned'?`<button class="btn btn-danger btn-xs" onclick="cancelOrder('${o.id}')">Cancel</button>`:''}
        </div></td>
      </tr>`).join('')
    : `<tr><td colspan="6" style="padding:32px;text-align:center;color:var(--text-muted)">No orders found</td></tr>`;
}

/* â”€â”€ USERS â”€â”€ */
async function loadUsers() {
  const rf = document.getElementById('role-filter')?.value;
  let q = window.sb.from('users').select('*').order('created_at',{ascending:false});
  if (rf) q = q.eq('role',rf);
  const { data, error } = await q;
  const tbody = document.getElementById('users-tb');
  if (error) { tbody.innerHTML=`<tr><td colspan="7" style="padding:24px;text-align:center;color:var(--rose-light)">${error.message}</td></tr>`; return; }
  tbody.innerHTML = (data||[]).length
    ? (data||[]).map(u=>`<tr>
        <td><div class="flex items-center gap-1">${renderAvatar(u,'av-sm')} <span>${u.name}</span></div></td>
        <td class="text-muted" style="font-size:12px">${u.email}</td>
        <td>${roleBadge(u.role)}</td>
        <td class="text-muted">${u.phone||'â€”'}</td>
        <td>${u.is_banned?statusBadge('banned'):u.is_verified?statusBadge('verified'):statusBadge('unverified')}</td>
        <td class="text-muted">${fmtDate(u.created_at)}</td>
        <td><div class="td-actions">
          ${!u.is_verified?`<button class="btn btn-success btn-xs" onclick="verifyUser('${u.id}')">âœ“ Verify</button>`:''}
          ${!u.is_banned?`<button class="btn btn-danger btn-xs" onclick="banUser('${u.id}')">Ban</button>`:`<button class="btn btn-secondary btn-xs" onclick="unbanUser('${u.id}')">Unban</button>`}
        </div></td>
      </tr>`).join('')
    : `<tr><td colspan="7" style="padding:32px;text-align:center;color:var(--text-muted)">No users found</td></tr>`;
}

async function verifyUser(id) {
  await window.sb.from('users').update({is_verified:true}).eq('id',id);
  toast('User verified âœ…','success'); loadUsers();
}
async function banUser(id) {
  if (!confirmAction('Ban this user? They will be unable to sign in.')) return;
  await window.sb.from('users').update({is_banned:true}).eq('id',id);
  toast('User banned','success'); loadUsers();
}
async function unbanUser(id) {
  await window.sb.from('users').update({is_banned:false}).eq('id',id);
  toast('User unbanned âœ…','success'); loadUsers();
}

/* â”€â”€ ASSIGN DELIVERIES â”€â”€ */
async function loadDeliveries() {
  const { data, error } = await window.sb.from('orders').select('*, users!buyer_id(name), products(name)').eq('order_status','placed').order('created_at',{ascending:false});
  const el = document.getElementById('del-list');
  if (error) { el.innerHTML=`<div class="alert alert-error">${error.message}</div>`; return; }
  if (!(data||[]).length) { el.innerHTML=`<div class="empty-state"><div class="empty-icon">âœ…</div><h3>All orders assigned!</h3></div>`; return; }
  el.innerHTML = (data||[]).map(o=>`
    <div class="order-card">
      <div class="order-header">
        <div><div class="order-id">${shortId(o.id)}</div><div class="order-name">${o.products?.name||'Product'}</div></div>
        ${statusBadge(o.order_status)}
      </div>
      <div class="order-meta">
        <div class="order-row"><span class="order-row-label">Buyer</span>${o.users?.name||'â€”'}</div>
        <div class="order-row"><span class="order-row-label">Deliver to</span><span class="text-sm">${o.drop_address||'â€”'}</span></div>
        <div class="order-row"><span class="order-row-label">Amount</span><span class="text-gold">${fmtCur(o.total_amount)}</span></div>
        <div class="order-row"><span class="order-row-label">Payment</span>${payBadge(o.payment_type)}</div>
      </div>
      <div class="order-actions"><button class="btn btn-primary btn-sm" onclick="openAssign('${o.id}')">ğŸšš Assign Delivery Partner</button></div>
    </div>`).join('');
}

async function loadPartners() {
  const { data } = await window.sb.from('users').select('id,name,phone').eq('role','delivery').eq('is_banned',false);
  PARTNERS = data||[];
  const sel = document.getElementById('asgn-partner');
  sel.innerHTML = `<option value="">Choose a delivery partnerâ€¦</option>` + PARTNERS.map(p=>`<option value="${p.id}">${p.name}${p.phone?' Â· '+p.phone:''}</option>`).join('');
}

function openAssign(orderId) {
  document.getElementById('asgn-order-id').value = orderId;
  document.getElementById('asgn-order-ref').textContent = shortId(orderId);
  document.getElementById('asgn-pickup').value = '';
  loadPartners();
  document.getElementById('assign-modal').classList.remove('hidden');
}

async function confirmAssign() {
  const orderId   = document.getElementById('asgn-order-id').value;
  const partnerId = document.getElementById('asgn-partner').value;
  const pickup    = document.getElementById('asgn-pickup').value.trim();
  if (!partnerId) { toast('Please select a delivery partner','error'); return; }
  btnLoad('asgn-confirm', true, 'â³ Assigningâ€¦');
  const updateData = { delivery_partner_id: partnerId, order_status: 'assigned' };
  if (pickup) updateData.pickup_address = pickup;
  const { error } = await window.sb.from('orders').update(updateData).eq('id', orderId);
  if (error) { toast(error.message,'error'); }
  else {
    const pname = PARTNERS.find(p=>p.id===partnerId)?.name||'Partner';
    toast(`Assigned to ${pname} âœ…`,'success');
    closeModal('assign-modal');
    loadDeliveries();
  }
  btnLoad('asgn-confirm', false);
}

/* â”€â”€ PAYMENTS â”€â”€ */
async function loadPayments() {
  const { data, error } = await window.sb.from('payments').select('*').order('created_at',{ascending:false});
  const payments = data||[];
  const wallet = payments.filter(p=>p.status==='admin_wallet').reduce((s,p)=>s+Number(p.amount||0),0);
  const rel    = payments.filter(p=>p.status==='released').reduce((s,p)=>s+Number(p.amount||0),0);
  const held   = payments.filter(p=>['held','returned'].includes(p.status)).reduce((s,p)=>s+Number(p.amount||0),0);
  document.getElementById('pay-wallet').textContent = fmtCur(wallet);
  document.getElementById('pay-rel').textContent    = fmtCur(rel);
  document.getElementById('pay-held').textContent   = fmtCur(held);
  const tbody = document.getElementById('pay-tb');
  tbody.innerHTML = payments.length
    ? payments.map(p=>`<tr>
        <td><code>${shortId(p.order_id||p.id)}</code></td>
        <td class="text-gold">${fmtCur(p.amount)}</td>
        <td>${payBadge(p.payment_method)}</td>
        <td>${statusBadge(p.status)}</td>
        <td class="text-muted">${fmtDate(p.created_at)}</td>
        <td><div class="td-actions">
          ${p.status==='admin_wallet'?`<button class="btn btn-success btn-xs" onclick="relPayment('${p.id}')">ğŸ’° Release</button>`:''}
          ${p.status==='admin_wallet'?`<button class="btn btn-danger btn-xs" onclick="holdPayment('${p.id}')">â¸ Hold</button>`:''}
          ${p.status==='held'?`<button class="btn btn-success btn-xs" onclick="relPayment('${p.id}')">Release</button>`:''}
        </div></td>
      </tr>`).join('')
    : `<tr><td colspan="6" style="padding:32px;text-align:center;color:var(--text-muted)">No payments</td></tr>`;
}
async function relPayment(id) {
  if (!confirmAction('Release this payment to the seller?')) return;
  await window.sb.from('payments').update({status:'released'}).eq('id',id);
  toast('Payment released âœ…','success'); loadPayments();
}
async function relByOrder(orderId) {
  if (!confirmAction('Release payment for this order?')) return;
  await window.sb.from('payments').update({status:'released'}).eq('order_id',orderId);
  toast('Payment released âœ…','success'); loadOrders();
}
async function holdPayment(id) {
  await window.sb.from('payments').update({status:'held'}).eq('id',id);
  toast('Payment held â¸','success'); loadPayments();
}
async function cancelOrder(orderId) {
  if (!confirmAction('Cancel this order?')) return;
  await window.sb.from('orders').update({order_status:'cancelled'}).eq('id',orderId);
  await window.sb.from('payments').update({status:'returned'}).eq('order_id',orderId);
  toast('Order cancelled','success'); loadOrders();
}

/* â”€â”€ PRODUCTS â”€â”€ */
async function loadProducts() {
  const sf = document.getElementById('prod-status')?.value;
  let q = window.sb.from('products').select('*, users!seller_id(name)').order('created_at',{ascending:false});
  if (sf!=='') q = q.eq('is_active', sf==='true');
  const { data, error } = await q;
  const grid = document.getElementById('prods-grid');
  if (error) { grid.innerHTML=`<div class="alert alert-error" style="grid-column:1/-1">${error.message}</div>`; return; }
  grid.innerHTML = (data||[]).length
    ? (data||[]).map(p=>`
      <div class="product-card" style="${!p.is_active?'opacity:0.5':''}">
        <div class="product-img">
          ${p.image_url?`<img src="${p.image_url}" loading="lazy" onerror="this.parentElement.innerHTML='${prodEmoji(p.category)}'" />`:''}
          ${!p.image_url?prodEmoji(p.category):''}
          <span class="product-cat">${p.category}</span>
        </div>
        <div class="product-body">
          <div class="product-name">${p.name}</div>
          <div class="product-desc" style="font-size:11px;color:var(--text-muted)">By: ${p.users?.name||'â€”'}</div>
          <div class="product-footer"><div class="product-price">â‚¹${Number(p.price).toLocaleString('en-IN')}</div><div class="product-qty">${p.quantity} left</div></div>
        </div>
        <div class="product-actions">
          ${p.is_active
            ? `<button class="btn btn-danger btn-sm w-full" onclick="toggleProduct('${p.id}',false)">ğŸ—‘ï¸ Deactivate</button>`
            : `<button class="btn btn-success btn-sm w-full" onclick="toggleProduct('${p.id}',true)">â™»ï¸ Restore</button>`}
        </div>
      </div>`).join('')
    : `<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">ğŸŒ¸</div><h3>No products</h3></div>`;
}
async function toggleProduct(id, active) {
  if (!confirmAction(`${active?'Restore':'Deactivate'} this product?`)) return;
  await window.sb.from('products').update({is_active:active}).eq('id',id);
  toast(`Product ${active?'restored':'deactivated'} âœ…`,'success'); loadProducts();
}

/* â”€â”€ PROFILE â”€â”€ */
function loadProfile() {
  document.getElementById('p-name').value  = USER.name||'';
  document.getElementById('p-phone').value = USER.phone||'';
  document.getElementById('p-email').value = USER.email||'';
  document.getElementById('prof-name').textContent = USER.name||'Admin';
  document.getElementById('prof-av-wrap').innerHTML = renderUploadableAvatar(USER,'av-xl');
}
function onAvatarChange(e) {
  const file=e.target.files[0]; if(!file) return;
  handleAvatarUpload(file, document.getElementById('prof-av-wrap').querySelector('.avatar'), USER.id, url=>{
    USER.avatar_url=url;
    document.getElementById('sb-av').innerHTML  = renderAvatar(USER,'av-md');
    document.getElementById('top-av').innerHTML = renderAvatar(USER,'av-sm');
  });
}
async function saveProfile() {
  const name=document.getElementById('p-name').value.trim();
  const phone=document.getElementById('p-phone').value.trim();
  if(!name){toast('Name is required','error');return;}
  btnLoad('save-btn',true,'â³ Savingâ€¦');
  const{error}=await window.sb.from('users').update({name,phone:phone||null}).eq('id',USER.id);
  if(error)toast(error.message,'error');
  else{USER={...USER,name,phone};document.getElementById('sb-name').textContent=name;document.getElementById('prof-name').textContent=name;toast('Saved âœ…','success');}
  btnLoad('save-btn',false);
}
async function resetPass(){
  const{error}=await window.sb.auth.resetPasswordForEmail(USER.email);
  if(error)toast(error.message,'error');
  else toast('Reset email sent âœ…','success');
}

/* â”€â”€ SETTINGS â”€â”€ */
function loadSettings() {
  const { url, key } = getCredentials();
  document.getElementById('cfg-url').value = url||'';
  document.getElementById('cfg-key').value = key||'';
  const indEl = document.getElementById('sb-conn-indicator');
  const txtEl = document.getElementById('sb-conn-text');
  if (url) {
    const domain = url.replace('https://','').split('.supabase.co')[0];
    txtEl.textContent = `Connected to ${domain}.supabase.co`;
    indEl.className = 'conn-indicator ok';
  } else {
    txtEl.textContent = 'Not configured';
    indEl.className = 'conn-indicator bad';
  }
  document.getElementById('info-db').textContent  = url ? url.replace('https://','') : 'Not set';
  document.getElementById('info-admin').textContent = USER.email;

  // Highlight active theme
  const t = document.documentElement.getAttribute('data-theme')||'dark';
  document.getElementById('theme-dark-btn').className  = t==='dark'  ? 'btn btn-primary' : 'btn btn-secondary';
  document.getElementById('theme-light-btn').className = t==='light' ? 'btn btn-primary' : 'btn btn-secondary';
}

function setTheme(t) {
  applyTheme(t);
  // Refresh button states
  document.getElementById('theme-dark-btn').className  = t==='dark'  ? 'btn btn-primary' : 'btn btn-secondary';
  document.getElementById('theme-light-btn').className = t==='light' ? 'btn btn-primary' : 'btn btn-secondary';
  toast(`${t==='dark'?'ğŸŒ™ Dark':'â˜€ï¸ Light'} mode enabled`,'success');
}

async function saveDBConfig() {
  const url = document.getElementById('cfg-url').value.trim();
  const key = document.getElementById('cfg-key').value.trim();
  if (!url || !key) { toast('Both URL and key are required','error'); return; }
  if (!url.includes('supabase.co') && !url.startsWith('http')) { toast('Please enter a valid Supabase URL','error'); return; }
  btnLoad('cfg-save-btn', true, 'â³ Savingâ€¦');
  try {
    updateStoredCredentials(url, key);
    // Test the new connection
    const { error } = await window.sb.from('users').select('id').limit(1);
    if (error && error.code !== 'PGRST116') throw error;
    const domain = url.replace('https://','').split('.supabase.co')[0];
    document.getElementById('sb-conn-text').textContent = `Connected to ${domain}.supabase.co`;
    document.getElementById('sb-conn-indicator').className = 'conn-indicator ok';
    document.getElementById('info-db').textContent = url.replace('https://','');
    toast('Database configuration saved âœ…','success');
  } catch(e) {
    document.getElementById('sb-conn-indicator').className = 'conn-indicator bad';
    document.getElementById('sb-conn-text').textContent = 'Connection failed';
    toast('Connection failed: ' + e.message,'error');
  }
  btnLoad('cfg-save-btn', false);
}

async function testDBConn() {
  toast('Testing connectionâ€¦');
  try {
    const { error, count } = await window.sb.from('users').select('id',{count:'exact',head:true});
    if (error && error.code !== 'PGRST116') throw error;
    toast(`Connection OK âœ… â€” ${count??'?'} users in database`,'success');
    document.getElementById('sb-conn-indicator').className = 'conn-indicator ok';
  } catch(e) {
    toast('Connection failed: ' + e.message,'error');
    document.getElementById('sb-conn-indicator').className = 'conn-indicator bad';
  }
}

/* â”€â”€ Helpers â”€â”€ */
function closeModal(id) { document.getElementById(id)?.classList.add('hidden'); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function hideSplash(){ const s=document.getElementById('loading-screen'); s.style.opacity='0'; setTimeout(()=>s.style.display='none',500); }
</script>
</body>
</html>
