<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Petal Rush â€” Delivery</title>
<link rel="stylesheet" href="../assets/css/styles.css">
<style>
.panel{display:none;}.panel.active{display:block;}
.buyer-info{background:var(--bg3);border-radius:9px;padding:12px;margin:12px 0;display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);transition:background 0.25s,border-color 0.25s;}
.nav-btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;}
.action-btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px;padding-top:14px;border-top:1px solid var(--border);}
</style>
</head>
<body>
<div id="loading-screen"><div class="ls-logo">Petal Rush</div><div class="ls-sub">Delivery Partner</div><div class="ls-bar"></div></div>
<div id="toast-root"></div>

<div class="dash-wrap hidden" id="app">
  <div class="sidebar-overlay" id="sb-overlay" onclick="closeSidebar()"></div>

  <nav class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <h1>Petal Rush</h1>
      <div class="sidebar-role">ğŸšš Delivery</div>
    </div>
    <div class="sidebar-user" onclick="navTo('profile')">
      <div id="sb-av"></div>
      <div class="sidebar-user-info">
        <div class="sidebar-user-name" id="sb-name">Loadingâ€¦</div>
        <div class="sidebar-user-email" id="sb-email">â€¦</div>
      </div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">Deliveries</div>
      <button class="nav-item active" data-panel="active" onclick="navTo('active')"><span class="nav-icon">ğŸ“¦</span>Active Orders<span class="nav-badge hidden" id="act-badge">0</span></button>
      <button class="nav-item" data-panel="done" onclick="navTo('done')"><span class="nav-icon">âœ…</span>Completed</button>
      <div class="nav-section">Account</div>
      <button class="nav-item" data-panel="profile" onclick="navTo('profile')"><span class="nav-icon">ğŸ‘¤</span>My Profile</button>
    </nav>
    <div class="sidebar-footer">
      <button class="nav-item" style="color:var(--rose-light)" onclick="logout()"><span class="nav-icon">ğŸšª</span>Sign Out</button>
    </div>
  </nav>

  <div class="topbar">
    <div class="topbar-left"><button class="menu-btn" onclick="toggleSidebar()">â˜°</button><div class="topbar-brand">My Deliveries</div></div>
    <div class="topbar-right">
      <button class="theme-toggle" onclick="toggleTheme()">â˜€ï¸</button>
      <div id="top-av" onclick="navTo('profile')" style="cursor:pointer"></div>
    </div>
  </div>

  <main class="main-content">

    <!-- ACTIVE -->
    <div class="panel active" id="panel-active">
      <div class="page-header">
        <div class="page-header-left"><h2>Active <em>Deliveries</em></h2><div class="page-sub">Your assigned orders</div></div>
        <div class="page-actions">
          <button class="btn btn-secondary" id="refresh-btn" onclick="loadActive()">ğŸ”„ Refresh</button>
        </div>
      </div>
      <div id="active-list"><div class="empty-state"><div class="empty-icon">â³</div><h3>Loadingâ€¦</h3></div></div>
    </div>

    <!-- DONE -->
    <div class="panel" id="panel-done">
      <div class="page-header"><div class="page-header-left"><h2><em>Completed</em> Deliveries</h2></div></div>
      <div class="stats-grid mb-2">
        <div class="stat-card"><div class="stat-icon">âœ…</div><div class="stat-value" id="st-del">0</div><div class="stat-label">Delivered</div></div>
        <div class="stat-card"><div class="stat-icon">â†©ï¸</div><div class="stat-value" id="st-ret">0</div><div class="stat-label">Returned</div></div>
      </div>
      <div id="done-list"><div class="empty-state"><div class="empty-icon">â³</div></div></div>
    </div>

    <!-- PROFILE -->
    <div class="panel" id="panel-profile">
      <div class="page-header"><div class="page-header-left"><h2>My <em>Profile</em></h2></div></div>
      <div class="profile-wrap">
        <div class="profile-card mb-2">
          <div class="profile-cover"><div class="profile-cover-av" id="prof-av-wrap"></div></div>
          <div class="profile-info">
            <div class="profile-name" id="prof-name">â€”</div>
            <div class="profile-role-badge">ğŸšš Delivery Partner</div>
            <p class="profile-hint">Tap your photo to upload a new avatar</p>
          </div>
        </div>
        <div class="card mb-2">
          <div class="card-header"><h3>Personal Information</h3></div>
          <div class="flex flex-col gap-2">
            <div class="form-row">
              <div class="form-group"><label>Full Name</label><input type="text" id="p-name" /></div>
              <div class="form-group"><label>Phone</label><input type="tel" id="p-phone" /></div>
            </div>
            <div class="form-group"><label>Email</label><input type="email" id="p-email" disabled /></div>
            <div class="form-group">
              <label>Home Address</label>
              <div class="flex gap-1">
                <input type="text" id="p-addr" style="flex:1" />
                <button class="btn btn-secondary btn-sm" id="p-gps" onclick="detectGPS('p-addr','p-gps')" style="flex-shrink:0">ğŸ“</button>
              </div>
            </div>
            <button class="btn btn-primary" id="save-btn" onclick="saveProfile()">Save Changes</button>
          </div>
        </div>
        <div class="card"><div class="card-header"><h3>Security</h3></div>
          <button class="btn btn-secondary btn-full" onclick="resetPass()">ğŸ”‘ Change Password</button>
        </div>
      </div>
    </div>

  </main>
</div>

<script src="../assets/js/config.js"></script>
<script src="../assets/js/auth.js"></script>
<script src="../assets/js/utils.js"></script>
<script>
let USER = null;

window.addEventListener('load', async () => {
  applyTheme(localStorage.getItem(PR_THEME_KEY)||'dark');
  await sleep(1500); hideSplash();
  USER = await requireRole('delivery');
  if (!USER) return;
  document.getElementById('sb-name').textContent  = USER.name;
  document.getElementById('sb-email').textContent = USER.email;
  document.getElementById('sb-av').innerHTML  = renderAvatar(USER,'av-md');
  document.getElementById('top-av').innerHTML = renderAvatar(USER,'av-sm');
  document.getElementById('app').classList.remove('hidden');
  navTo('active');
});

window.showPanel = navTo;
function navTo(id) {
  ['active','done','profile'].forEach(p=>{
    const el=document.getElementById(`panel-${p}`);
    if(el) el.style.display = p===id?'':'none';
  });
  setActiveNav(id);
  closeSidebar();
  if(id==='active')  loadActive();
  if(id==='done')    loadDone();
  if(id==='profile') loadProfile();
}

/* â”€â”€ ACTIVE DELIVERIES â”€â”€ */
async function loadActive() {
  btnLoad('refresh-btn', true, 'ğŸ”„ Loadingâ€¦');
  const el = document.getElementById('active-list');
  const { data, error } = await window.sb
    .from('orders')
    .select('*, products(name,category,price), users!buyer_id(name,phone)')
    .eq('delivery_partner_id', USER.id)
    .in('order_status', ['assigned','picked'])
    .order('updated_at',{ascending:false});
  btnLoad('refresh-btn', false);
  const orders = data||[];
  const badge = document.getElementById('act-badge');
  if (orders.length) { badge.textContent=orders.length; badge.classList.remove('hidden'); }
  else badge.classList.add('hidden');
  if (error) { el.innerHTML=`<div class="alert alert-error">${error.message}</div>`; return; }
  if (!orders.length) {
    el.innerHTML=`<div class="empty-state"><div class="empty-icon">ğŸ“­</div><h3>No active deliveries</h3><p>New assignments will appear here. Use Refresh to check.</p></div>`;
    return;
  }
  el.innerHTML = orders.map(o => renderCard(o, false)).join('');
}

/* â”€â”€ COMPLETED â”€â”€ */
async function loadDone() {
  const { data, error } = await window.sb
    .from('orders')
    .select('*, products(name,category)')
    .eq('delivery_partner_id', USER.id)
    .in('order_status', ['delivered','returned'])
    .order('updated_at',{ascending:false});
  const orders = data||[];
  document.getElementById('st-del').textContent = orders.filter(o=>o.order_status==='delivered').length;
  document.getElementById('st-ret').textContent = orders.filter(o=>o.order_status==='returned').length;
  const el = document.getElementById('done-list');
  if (!orders.length) { el.innerHTML=`<div class="empty-state"><div class="empty-icon">âœ…</div><h3>No completed deliveries yet</h3></div>`; return; }
  el.innerHTML = orders.map(o => renderCard(o, true)).join('');
}

function renderCard(o, done) {
  const status  = o.order_status;
  const product = o.products?.name || 'Product';
  const pickup  = o.pickup_address || 'Contact seller for pickup location';
  const drop    = o.drop_address   || 'Buyer address on file';
  const bname   = o.users?.name    || 'â€”';
  const bphone  = o.users?.phone   || '';

  return `
  <div class="delivery-card">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:10px">
      <div>
        <div class="order-id">${shortId(o.id)}</div>
        <div style="font-family:'Cormorant Garamond',serif;font-size:20px;margin-top:3px;color:var(--cream)">${product}</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:5px">
        ${statusBadge(status)}
        ${payBadge(o.payment_type)}
        ${o.payment_type==='cod'?`<span class="badge badge-gold">ğŸ’µ Collect ${fmtCur(o.total_amount)}</span>`:''}
      </div>
    </div>

    <div class="buyer-info">
      <div>
        <div class="text-xs text-muted" style="text-transform:uppercase;letter-spacing:0.1em">Customer</div>
        <div style="font-size:14px;margin-top:2px">${bname}</div>
      </div>
      ${bphone?`<a href="tel:${bphone}" class="btn btn-secondary btn-sm">ğŸ“ Call</a>`:''}
    </div>

    <div class="route-wrap">
      <div style="position:relative;padding-left:20px">
        <div class="route-dot pickup" style="top:8px;left:0;position:absolute"></div>
        <div class="route-label">Pickup Location</div>
        <div class="route-addr">${pickup}</div>
      </div>
      <div style="width:1px;height:16px;background:var(--border);margin-left:3px"></div>
      <div style="position:relative;padding-left:20px">
        <div class="route-dot drop" style="top:8px;left:0;position:absolute"></div>
        <div class="route-label">Drop-off Location</div>
        <div class="route-addr">${drop}</div>
      </div>
    </div>

    ${!done?`
    <div class="nav-btns">
      <a class="gps-btn gps-pickup" href="${mapsLink(pickup)}" target="_blank" rel="noopener noreferrer">ğŸ“ Navigate to Pickup</a>
      <a class="gps-btn gps-drop"   href="${mapsLink(drop)}"   target="_blank" rel="noopener noreferrer">ğŸ—ºï¸ Navigate to Drop</a>
    </div>
    <div class="action-btns">
      ${status==='assigned' ? `<button class="btn btn-secondary btn-sm" onclick="updateStatus('${o.id}','picked')">ğŸ“¦ Mark Picked Up</button>` : ''}
      ${status==='picked'   ? `<button class="btn btn-success btn-sm" onclick="updateStatus('${o.id}','delivered')">âœ… Mark Delivered</button>` : ''}
      <button class="btn btn-danger btn-sm" onclick="updateStatus('${o.id}','returned')">â†©ï¸ Return Order</button>
    </div>`:''}
  </div>`;
}

async function updateStatus(id, ns) {
  const msgs = { picked:'Mark this order as picked up from seller?', delivered:'Mark as delivered to customer?', returned:'Mark as returned? Payment will be held by admin.' };
  if (!confirmAction(msgs[ns])) return;
  const { error } = await window.sb.from('orders').update({ order_status:ns }).eq('id',id).eq('delivery_partner_id',USER.id);
  if (error) { toast(error.message,'error'); return; }
  if (ns==='returned') {
    await window.sb.from('payments').update({status:'returned'}).eq('order_id',id);
  }
  toast(`Marked as ${ns} âœ…`,'success');
  loadActive();
}

/* â”€â”€ PROFILE â”€â”€ */
function loadProfile() {
  document.getElementById('p-name').value  = USER.name||'';
  document.getElementById('p-phone').value = USER.phone||'';
  document.getElementById('p-email').value = USER.email||'';
  document.getElementById('p-addr').value  = USER.address||'';
  document.getElementById('prof-name').textContent = USER.name||'â€”';
  document.getElementById('prof-av-wrap').innerHTML = renderUploadableAvatar(USER,'av-xl');
}
function onAvatarChange(e) {
  const file=e.target.files[0]; if(!file)return;
  handleAvatarUpload(file, document.getElementById('prof-av-wrap').querySelector('.avatar'), USER.id, url=>{
    USER.avatar_url=url;
    document.getElementById('sb-av').innerHTML  = renderAvatar(USER,'av-md');
    document.getElementById('top-av').innerHTML = renderAvatar(USER,'av-sm');
  });
}
async function saveProfile() {
  const name=document.getElementById('p-name').value.trim();
  const phone=document.getElementById('p-phone').value.trim();
  const addr=document.getElementById('p-addr').value.trim();
  if(!name){toast('Name is required','error');return;}
  btnLoad('save-btn',true,'â³ Savingâ€¦');
  const{error}=await window.sb.from('users').update({name,phone:phone||null,address:addr||null}).eq('id',USER.id);
  if(error)toast(error.message,'error');
  else{USER={...USER,name,phone,address:addr};document.getElementById('sb-name').textContent=name;document.getElementById('prof-name').textContent=name;toast('Saved âœ…','success');}
  btnLoad('save-btn',false);
}
async function resetPass(){const{error}=await window.sb.auth.resetPasswordForEmail(USER.email);if(error)toast(error.message,'error');else toast('Reset email sent âœ…','success');}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
function hideSplash(){const s=document.getElementById('loading-screen');s.style.opacity='0';setTimeout(()=>s.style.display='none',500);}
</script>
</body>
</html>
